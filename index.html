<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDC East Attendance Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --sidebar-width: 250px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .login-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 400px;
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 20px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        /* Dashboard Styles */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary-color);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .sidebar-header h3 {
            font-size: 22px;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        
        .sidebar-menu a {
            display: block;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 3px solid var(--secondary-color);
        }
        
        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .header h2 {
            color: var(--primary-color);
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 500;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--success-color);
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-danger {
            background: var(--danger-color);
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: var(--warning-color);
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .form-group {
            flex: 1 0 50%;
            padding: 0 10px;
            margin-bottom: 15px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
        }
        
        .shift-1 { background-color: #d4edda; }
        .shift-2 { background-color: #cce5ff; }
        .shift-3 { background-color: #f8d7da; }
        .shift-11 { background-color: #fff3cd; }
        .shift-22 { background-color: #e2e3e5; }
        .shift-o { background-color: #d1ecf1; }
        .shift-c { background-color: #f8d7da; }
        
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .filter-container .form-group {
            flex: 1 0 200px;
            margin-bottom: 0;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            text-align: center;
        }
        
        .summary-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .summary-card .label {
            font-size: 14px;
            color: #666;
        }
        
        .summary-card .icon {
            font-size: 36px;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--secondary-color);
            color: var(--secondary-color);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-buttons button {
            flex: 1;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--success-color);
            color: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            display: flex;
            align-items: center;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.error {
            background: var(--danger-color);
        }
        
        .toast.warning {
            background: var(--warning-color);
        }
        
        .toast i {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .date-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .attendance-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .fixed-table-container {
            overflow-x: auto;
            max-height: 500px;
        }
        
        .date-column {
            min-width: 80px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-row .form-group {
                flex: 1 0 100%;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .filter-container {
                flex-direction: column;
            }
            
            .filter-container .form-group {
                flex: 1 0 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-form">
            <h2>CDC East Attendance System</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-block">Login</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>CDC East System</h3>
                <p id="userRole">Admin</p>
            </div>
            <ul class="sidebar-menu" id="sidebarMenu">
                <!-- Menu items will be populated by JavaScript -->
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2 id="pageTitle">Dashboard</h2>
                <div class="user-info">
                    <span id="userName">Admin</span>
                    <button id="logoutBtn" class="btn btn-sm">Logout</button>
                </div>
            </div>

            <div class="content" id="mainContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="modalContent">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Notification</span>
    </div>

    <script>
        // Initialize data
        let currentUser = null;
        let isAdmin = false;
        let employees = [];
        let attendanceData = [];
        let leaveData = [];
        let overtimeData = [];
        let overtimeCalcData = [];
        let appSettings = [];

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const sidebarMenu = document.getElementById('sidebarMenu');
        const mainContent = document.getElementById('mainContent');
        const pageTitle = document.getElementById('pageTitle');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.querySelector('.close-modal');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        // Initialize the app
        function initApp() {
            // Load data from localStorage
            loadDataFromStorage();
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                isAdmin = currentUser.isAdmin;
                showDashboard();
            } else {
                showLoginPage();
            }
            
            // Event listeners
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            closeModal.addEventListener('click', closeModalHandler);
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModalHandler();
                }
            });
        }

        // Load data from localStorage
        function loadDataFromStorage() {
            // Load employees
            const savedEmployees = localStorage.getItem('employees');
            if (savedEmployees) {
                employees = JSON.parse(savedEmployees);
            } else {
                // Default employees
                employees = [
                    { id: 1, username: 'user1', password: 'user123', fullName: 'User One', jobPosition: 'Dispatcher', isAdmin: false },
                    { id: 2, username: 'user2', password: 'user123', fullName: 'User Two', jobPosition: 'Booking', isAdmin: false },
                    { id: 3, username: 'admin', password: 'admin123', fullName: 'Administrator', jobPosition: 'Admin', isAdmin: true }
                ];
                saveDataToStorage();
            }
            
            // Load attendance data
            const savedAttendance = localStorage.getItem('attendanceData');
            if (savedAttendance) {
                attendanceData = JSON.parse(savedAttendance);
            }
            
            // Load leave data
            const savedLeave = localStorage.getItem('leaveData');
            if (savedLeave) {
                leaveData = JSON.parse(savedLeave);
            }
            
            // Load overtime data
            const savedOvertime = localStorage.getItem('overtimeData');
            if (savedOvertime) {
                overtimeData = JSON.parse(savedOvertime);
            }
            
            // Load overtime calculation data
            const savedOvertimeCalc = localStorage.getItem('overtimeCalcData');
            if (savedOvertimeCalc) {
                overtimeCalcData = JSON.parse(savedOvertimeCalc);
            }
            
            // Load app settings
            const savedSettings = localStorage.getItem('appSettings');
            if (savedSettings) {
                appSettings = JSON.parse(savedSettings);
            }
        }

        // Save data to localStorage
        function saveDataToStorage() {
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            localStorage.setItem('leaveData', JSON.stringify(leaveData));
            localStorage.setItem('overtimeData', JSON.stringify(overtimeData));
            localStorage.setItem('overtimeCalcData', JSON.stringify(overtimeCalcData));
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
        }

        // Show login page
        function showLoginPage() {
            loginPage.classList.remove('hidden');
            dashboard.classList.add('hidden');
        }

        // Show dashboard
        function showDashboard() {
            loginPage.classList.add('hidden');
            dashboard.classList.remove('hidden');
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.fullName;
            document.getElementById('userRole').textContent = currentUser.isAdmin ? 'Admin' : 'User';
            
            // Setup sidebar menu
            setupSidebarMenu();
            
            // Show default page
            if (isAdmin) {
                showInputAttendance();
            } else {
                showOutputAttendance();
            }
        }

        // Setup sidebar menu
        function setupSidebarMenu() {
            sidebarMenu.innerHTML = '';
            
            if (isAdmin) {
                const adminMenuItems = [
                    { icon: 'fa-clock', text: 'Input Absen Tabel', action: 'showInputAttendance' },
                    { icon: 'fa-table', text: 'Output Absen Tabel', action: 'showOutputAttendance' },
                    { icon: 'fa-calendar-times', text: 'Input Cuti', action: 'showInputLeave' },
                    { icon: 'fa-list-alt', text: 'Summary Cuti', action: 'showSummaryLeave' },
                    { icon: 'fa-clipboard-list', text: 'Detail Absen', action: 'showDetailAttendance' },
                    { icon: 'fa-hourglass-half', text: 'Overtime Detail', action: 'showOvertimeDetail' },
                    { icon: 'fa-calculator', text: 'Overtime Calculation', action: 'showOvertimeCalculation' },
                    { icon: 'fa-chart-bar', text: 'Summary Overtime', action: 'showSummaryOvertime' },
                    { icon: 'fa-cogs', text: 'Management Aplikasi', action: 'showManagementApp' }
                ];
                
                adminMenuItems.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#" onclick="${item.action}"><i class="fas ${item.icon}"></i> ${item.text}</a>`;
                    sidebarMenu.appendChild(li);
                });
            } else {
                const userMenuItems = [
                    { icon: 'fa-table', text: 'Output Absen Tabel', action: 'showOutputAttendance' },
                    { icon: 'fa-list-alt', text: 'Summary Cuti', action: 'showSummaryLeave' },
                    { icon: 'fa-edit', text: 'Overtime Form', action: 'showOvertimeForm' },
                    { icon: 'fa-hourglass-half', text: 'Overtime Detail', action: 'showOvertimeDetail' }
                ];
                
                userMenuItems.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#" onclick="${item.action}"><i class="fas ${item.icon}"></i> ${item.text}</a>`;
                    sidebarMenu.appendChild(li);
                });
            }
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Find user
            const user = employees.find(emp => emp.username === username && emp.password === password);
            
            if (user) {
                currentUser = user;
                isAdmin = user.isAdmin;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showDashboard();
                showToast('Login successful', 'success');
            } else {
                showToast('Invalid username or password', 'error');
            }
        }

        // Handle logout
        function handleLogout() {
            currentUser = null;
            isAdmin = false;
            localStorage.removeItem('currentUser');
            showLoginPage();
            showToast('Logged out successfully', 'success');
        }

        // Show modal
        function showModal(title, content) {
            modalContent.innerHTML = `
                <h3>${title}</h3>
                ${content}
            `;
            modal.style.display = 'block';
        }

        // Close modal
        function closeModalHandler() {
            modal.style.display = 'none';
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            
            // Set toast class based on type
            toast.className = 'toast';
            if (type === 'error') {
                toast.classList.add('error');
                toast.querySelector('i').className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                toast.classList.add('warning');
                toast.querySelector('i').className = 'fas fa-exclamation-triangle';
            } else {
                toast.querySelector('i').className = 'fas fa-check-circle';
            }
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Format date
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        // Format time
        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            return `${hours}:${minutes}`;
        }

        // Get shift name
        function getShiftName(shiftCode) {
            const shifts = {
                '1': 'Pagi',
                '2': 'Siang',
                '3': 'Malam',
                '11': 'Pjk Pagi',
                '22': 'Pjk Siang',
                'O': 'Libur',
                'C': 'Cuti'
            };
            return shifts[shiftCode] || shiftCode;
        }

        // Get shift class
        function getShiftClass(shiftCode) {
            return `shift-${shiftCode}`;
        }

        // Generate date range
        function generateDateRange(startDate, endDate) {
            const dates = [];
            const currentDate = new Date(startDate);
            const end = new Date(endDate);
            
            while (currentDate <= end) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return dates;
        }

        // Input Attendance Page - MODIFIED
        function showInputAttendance() {
            pageTitle.textContent = 'Input Absen Tabel';
            
            // Set default date range (current week)
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const startDate = startOfWeek.toISOString().split('T')[0];
            const endDate = endOfWeek.toISOString().split('T')[0];
            
            let content = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Attendance Entry</h3>
                    </div>
                    
                    <div class="filter-container">
                        <div class="form-group">
                            <label for="filterStartDate">Start Date</label>
                            <input type="date" id="filterStartDate" class="form-control" value="${startDate}">
                        </div>
                        <div class="form-group">
                            <label for="filterEndDate">End Date</label>
                            <input type="date" id="filterEndDate" class="form-control" value="${endDate}">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="applyDateFilter()">Apply</button>
                                <button class="btn btn-secondary" onclick="refreshAttendanceTable()">Refresh</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fixed-table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Employee Name</th>
                                    <th>Job Position</th>
                                    <!-- Date columns will be added dynamically -->
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="attendance-actions">
                        <button class="btn btn-primary" onclick="addAttendanceRow()">
                            <i class="fas fa-plus"></i> Add Row
                        </button>
                        <button class="btn btn-success" onclick="saveAttendance()">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                </div>
            `;
            
            mainContent.innerHTML = content;
            
            // Load attendance table with default date range
            loadAttendanceTable(startDate, endDate);
        }

        // Load attendance table with date columns - MODIFIED
        function loadAttendanceTable(startDate, endDate) {
            const tableBody = document.getElementById('attendanceTableBody');
            const tableHead = document.querySelector('#attendanceTableBody').previousElementSibling;
            
            // Clear existing content
            tableBody.innerHTML = '';
            
            // Clear existing header columns except first two
            const headerRow = tableHead.querySelector('tr');
            while (headerRow.children.length > 2) {
                headerRow.removeChild(headerRow.lastChild);
            }
            
            // Generate date range
            const dates = generateDateRange(startDate, endDate);
            
            // Add date columns to header
            dates.forEach(date => {
                const th = document.createElement('th');
                th.className = 'date-column';
                th.textContent = formatDate(date.toISOString().split('T')[0]);
                headerRow.appendChild(th);
            });
            
            // Add Action column
            const actionTh = document.createElement('th');
            actionTh.textContent = 'Action';
            headerRow.appendChild(actionTh);
            
            // Get employees who are not admins
            const nonAdminEmployees = employees.filter(emp => !emp.isAdmin);
            
            // Create rows for each employee
            nonAdminEmployees.forEach(employee => {
                const row = document.createElement('tr');
                row.dataset.employeeId = employee.id;
                
                // Employee name and position
                row.innerHTML = `
                    <td>${employee.fullName}</td>
                    <td>${employee.jobPosition}</td>
                `;
                
                // Add date cells
                dates.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const td = document.createElement('td');
                    td.className = 'date-column';
                    td.dataset.date = dateStr;
                    
                    // Find existing attendance for this date
                    const existingAttendance = attendanceData.find(att => 
                        att.employeeId === employee.id && att.date === dateStr
                    );
                    
                    if (existingAttendance) {
                        const select = document.createElement('select');
                        select.className = 'form-control date-input';
                        select.dataset.employeeId = employee.id;
                        select.dataset.date = dateStr;
                        select.dataset.field = 'shiftCode';
                        
                        // Add shift options
                        const shifts = [
                            { value: '1', label: '1 (Pagi)' },
                            { value: '2', label: '2 (Siang)' },
                            { value: '3', label: '3 (Malam)' },
                            { value: '11', label: '11 (Pjk Pagi)' },
                            { value: '22', label: '22 (Pjk Siang)' },
                            { value: 'O', label: 'O (Libur)' },
                            { value: 'C', label: 'C (Cuti)' }
                        ];
                        
                        shifts.forEach(shift => {
                            const option = document.createElement('option');
                            option.value = shift.value;
                            option.textContent = shift.label;
                            option.selected = existingAttendance.shiftCode === shift.value;
                            select.appendChild(option);
                        });
                        
                        // Add event listener to change shift color
                        select.addEventListener('change', function() {
                            const shiftCode = this.value;
                            const shiftClass = getShiftClass(shiftCode);
                            
                            // Remove all shift classes
                            td.classList.remove('shift-1', 'shift-2', 'shift-3', 'shift-11', 'shift-22', 'shift-o', 'shift-c');
                            
                            // Add selected shift class
                            td.classList.add(shiftClass);
                        });
                        
                        // Initialize with current shift color
                        const shiftClass = getShiftClass(existingAttendance.shiftCode);
                        td.classList.add(shiftClass);
                        
                        td.appendChild(select);
                    } else {
                        const select = document.createElement('select');
                        select.className = 'form-control date-input';
                        select.dataset.employeeId = employee.id;
                        select.dataset.date = dateStr;
                        select.dataset.field = 'shiftCode';
                        
                        // Add shift options
                        const shifts = [
                            { value: '', label: '-' },
                            { value: '1', label: '1 (Pagi)' },
                            { value: '2', label: '2 (Siang)' },
                            { value: '3', label: '3 (Malam)' },
                            { value: '11', label: '11 (Pjk Pagi)' },
                            { value: '22', label: '22 (Pjk Siang)' },
                            { value: 'O', label: 'O (Libur)' },
                            { value: 'C', label: 'C (Cuti)' }
                        ];
                        
                        shifts.forEach(shift => {
                            const option = document.createElement('option');
                            option.value = shift.value;
                            option.textContent = shift.label;
                            select.appendChild(option);
                        });
                        
                        // Add event listener to change shift color
                        select.addEventListener('change', function() {
                            const shiftCode = this.value;
                            const shiftClass = getShiftClass(shiftCode);
                            
                            // Remove all shift classes
                            td.classList.remove('shift-1', 'shift-2', 'shift-3', 'shift-11', 'shift-22', 'shift-o', 'shift-c');
                            
                            // Add selected shift class
                            if (shiftCode) {
                                td.classList.add(shiftClass);
                            }
                        });
                        
                        td.appendChild(select);
                    }
                    
                    row.appendChild(td);
                });
                
                // Add Action cell
                const actionTd = document.createElement('td');
                actionTd.innerHTML = `
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editEmployeeAttendance(${employee.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteEmployeeAttendance(${employee.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                row.appendChild(actionTd);
                
                tableBody.appendChild(row);
            });
        }

        // Apply date filter - NEW
        function applyDateFilter() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showToast('Please select both start and end dates', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showToast('Start date cannot be after end date', 'error');
                return;
            }
            
            loadAttendanceTable(startDate, endDate);
            showToast('Date filter applied', 'success');
        }

        // Refresh attendance table - NEW
        function refreshAttendanceTable() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (startDate && endDate) {
                loadAttendanceTable(startDate, endDate);
                showToast('Table refreshed', 'success');
            } else {
                showToast('Please apply date filter first', 'warning');
            }
        }

        // Add attendance row - MODIFIED
        function addAttendanceRow() {
            // Get employees who are not admins
            const nonAdminEmployees = employees.filter(emp => !emp.isAdmin);
            
            if (nonAdminEmployees.length === 0) {
                showToast('No employees available', 'warning');
                return;
            }
            
            // Create a modal to select employee
            let employeeOptions = '';
            nonAdminEmployees.forEach(emp => {
                employeeOptions += `<option value="${emp.id}">${emp.fullName} (${emp.jobPosition})</option>`;
            });
            
            // Get current date range
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            const modalContent = `
                <div class="form-group">
                    <label for="employeeSelect">Select Employee</label>
                    <select id="employeeSelect" class="form-control">
                        ${employeeOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label>Date Range</label>
                    <input type="text" class="form-control" value="${startDate} to ${endDate}" readonly>
                </div>
                <div class="form-group">
                    <label for="shiftCode">Shift Code</label>
                    <select id="shiftCode" class="form-control">
                        <option value="1">1 (Pagi)</option>
                        <option value="2">2 (Siang)</option>
                        <option value="3">3 (Malam)</option>
                        <option value="11">11 (Pjk Pagi)</option>
                        <option value="22">22 (Pjk Siang)</option>
                        <option value="O">O (Libur)</option>
                        <option value="C">C (Cuti)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="checkIn">Check In</label>
                    <input type="time" id="checkIn" class="form-control" value="08:00">
                </div>
                <div class="form-group">
                    <label for="checkOut">Check Out</label>
                    <input type="time" id="checkOut" class="form-control" value="17:00">
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" class="form-control">
                        <option value="Hadir">Hadir</option>
                        <option value="Libur">Libur</option>
                        <option value="Cuti">Cuti</option>
                        <option value="Izin">Izin</option>
                        <option value="Sakit">Sakit</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Apply to All Dates in Range</label>
                    <label>
                        <input type="checkbox" id="applyToAll" checked> Yes
                    </label>
                </div>
                <button class="btn btn-primary" onclick="addNewAttendance()">Add Attendance</button>
            `;
            
            showModal('Add New Attendance', modalContent);
        }

        // Add new attendance - MODIFIED
        function addNewAttendance() {
            const employeeId = parseInt(document.getElementById('employeeSelect').value);
            const shiftCode = document.getElementById('shiftCode').value;
            const checkIn = document.getElementById('checkIn').value;
            const checkOut = document.getElementById('checkOut').value;
            const status = document.getElementById('status').value;
            const applyToAll = document.getElementById('applyToAll').checked;
            
            // Get date range
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (applyToAll) {
                // Generate all dates in range
                const dates = generateDateRange(startDate, endDate);
                
                // Add attendance for each date
                dates.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    
                    // Check if attendance already exists
                    const existingAttendance = attendanceData.find(att => 
                        att.employeeId === employeeId && att.date === dateStr
                    );
                    
                    if (!existingAttendance) {
                        // Add new attendance
                        const newAttendance = {
                            id: attendanceData.length > 0 ? Math.max(...attendanceData.map(a => a.id)) + 1 : 1,
                            employeeId,
                            date: dateStr,
                            shiftCode,
                            checkIn,
                            checkOut,
                            status
                        };
                        
                        attendanceData.push(newAttendance);
                    }
                });
            } else {
                // Add for a single date (first date in range)
                const dateStr = startDate;
                
                // Check if attendance already exists
                const existingAttendance = attendanceData.find(att => 
                    att.employeeId === employeeId && att.date === dateStr
                );
                
                if (existingAttendance) {
                    showToast('Attendance for this employee and date already exists', 'error');
                    return;
                }
                
                // Add new attendance
                const newAttendance = {
                    id: attendanceData.length > 0 ? Math.max(...attendanceData.map(a => a.id)) + 1 : 1,
                    employeeId,
                    date: dateStr,
                    shiftCode,
                    checkIn,
                    checkOut,
                    status
                };
                
                attendanceData.push(newAttendance);
            }
            
            saveDataToStorage();
            
            closeModalHandler();
            loadAttendanceTable(startDate, endDate);
            showToast('Attendance added successfully', 'success');
        }

        // Edit employee attendance - NEW
        function editEmployeeAttendance(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            
            if (!employee) {
                showToast('Employee not found', 'error');
                return;
            }
            
            // Get date range
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            // Find all attendance for this employee in the date range
            const employeeAttendance = attendanceData.filter(att => {
                return att.employeeId === employeeId && 
                       att.date >= startDate && 
                       att.date <= endDate;
            });
            
            if (employeeAttendance.length === 0) {
                showToast('No attendance found for this employee in the selected date range', 'warning');
                return;
            }
            
            // Create modal to edit attendance
            let attendanceHtml = '';
            employeeAttendance.forEach(att => {
                attendanceHtml += `
                    <div class="form-group">
                        <label>${formatDate(att.date)}</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="shift-${att.id}" class="form-control" style="flex: 1;">
                                <option value="1" ${att.shiftCode === '1' ? 'selected' : ''}>1 (Pagi)</option>
                                <option value="2" ${att.shiftCode === '2' ? 'selected' : ''}>2 (Siang)</option>
                                <option value="3" ${att.shiftCode === '3' ? 'selected' : ''}>3 (Malam)</option>
                                <option value="11" ${att.shiftCode === '11' ? 'selected' : ''}>11 (Pjk Pagi)</option>
                                <option value="22" ${att.shiftCode === '22' ? 'selected' : ''}>22 (Pjk Siang)</option>
                                <option value="O" ${att.shiftCode === 'O' ? 'selected' : ''}>O (Libur)</option>
                                <option value="C" ${att.shiftCode === 'C' ? 'selected' : ''}>C (Cuti)</option>
                            </select>
                            <select id="status-${att.id}" class="form-control" style="flex: 1;">
                                <option value="Hadir" ${att.status === 'Hadir' ? 'selected' : ''}>Hadir</option>
                                <option value="Libur" ${att.status === 'Libur' ? 'selected' : ''}>Libur</option>
                                <option value="Cuti" ${att.status === 'Cuti' ? 'selected' : ''}>Cuti</option>
                                <option value="Izin" ${att.status === 'Izin' ? 'selected' : ''}>Izin</option>
                                <option value="Sakit" ${att.status === 'Sakit' ? 'selected' : ''}>Sakit</option>
                            </select>
                        </div>
                    </div>
                `;
            });
            
            const modalContent = `
                <div class="form-group">
                    <label>Employee</label>
                    <input type="text" class="form-control" value="${employee.fullName}" readonly>
                </div>
                <div class="form-group">
                    <label>Date Range</label>
                    <input type="text" class="form-control" value="${startDate} to ${endDate}" readonly>
                </div>
                ${attendanceHtml}
                <button class="btn btn-primary" onclick="updateEmployeeAttendance(${employeeId})">Update Attendance</button>
            `;
            
            showModal('Edit Attendance', modalContent);
        }

        // Update employee attendance - NEW
        function updateEmployeeAttendance(employeeId) {
            // Get date range
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            // Find all attendance for this employee in the date range
            const employeeAttendance = attendanceData.filter(att => {
                return att.employeeId === employeeId && 
                       att.date >= startDate && 
                       att.date <= endDate;
            });
            
            // Update each attendance
            employeeAttendance.forEach(att => {
                const shiftCode = document.getElementById(`shift-${att.id}`).value;
                const status = document.getElementById(`status-${att.id}`).value;
                
                // Find attendance index
                const attendanceIndex = attendanceData.findIndex(a => a.id === att.id);
                
                if (attendanceIndex !== -1) {
                    attendanceData[attendanceIndex] = {
                        ...attendanceData[attendanceIndex],
                        shiftCode,
                        status
                    };
                }
            });
            
            saveDataToStorage();
            
            closeModalHandler();
            loadAttendanceTable(startDate, endDate);
            showToast('Attendance updated successfully', 'success');
        }

        // Delete employee attendance - NEW
        function deleteEmployeeAttendance(employeeId) {
            if (!confirm('Are you sure you want to delete all attendance for this employee in the selected date range?')) {
                return;
            }
            
            // Get date range
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            // Find all attendance for this employee in the date range
            const employeeAttendance = attendanceData.filter(att => {
                return att.employeeId === employeeId && 
                       att.date >= startDate && 
                       att.date <= endDate;
            });
            
            if (employeeAttendance.length === 0) {
                showToast('No attendance found for this employee in the selected date range', 'warning');
                return;
            }
            
            // Delete each attendance
            employeeAttendance.forEach(att => {
                const attendanceIndex = attendanceData.findIndex(a => a.id === att.id);
                if (attendanceIndex !== -1) {
                    attendanceData.splice(attendanceIndex, 1);
                }
            });
            
            saveDataToStorage();
            
            loadAttendanceTable(startDate, endDate);
            showToast('Attendance deleted successfully', 'success');
        }

        // Save attendance - MODIFIED
        function saveAttendance() {
            // Get date range
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showToast('Please select date range first', 'error');
                return;
            }
            
            // Get all date inputs
            const dateInputs = document.querySelectorAll('.date-input');
            
            // Process each date input
            dateInputs.forEach(input => {
                const employeeId = parseInt(input.dataset.employeeId);
                const date = input.dataset.date;
                const shiftCode = input.value;
                
                if (shiftCode) {  // Only save if shift code is selected
                    // Check if attendance already exists
                    const existingAttendanceIndex = attendanceData.findIndex(att => 
                        att.employeeId === employeeId && att.date === date
                    );
                    
                    if (existingAttendanceIndex !== -1) {
                        // Update existing attendance
                        attendanceData[existingAttendanceIndex] = {
                            ...attendanceData[existingAttendanceIndex],
                            shiftCode
                        };
                    } else {
                        // Add new attendance
                        const newAttendance = {
                            id: attendanceData.length > 0 ? Math.max(...attendanceData.map(a => a.id)) + 1 : 1,
                            employeeId,
                            date,
                            shiftCode,
                            checkIn: '08:00',
                            checkOut: '17:00',
                            status: 'Hadir'
                        };
                        
                        attendanceData.push(newAttendance);
                    }
                }
            });
            
            saveDataToStorage();
            showToast('Attendance saved successfully', 'success');
        }

        // Output Attendance Page
        function showOutputAttendance() {
            pageTitle.textContent = 'Output Absen Tabel';
            
            let content = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Attendance Output</h3>
                    </div>
                    <div class="filter-container">
                        <div class="form-group">
                            <label for="filterDateFrom">Date From</label>
                            <input type="date" id="filterDateFrom" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="filterDateTo">Date To</label>
                            <input type="date" id="filterDateTo" class="form-control">
                        </div>
                        ${isAdmin ? `
                        <div class="form-group">
                            <label for="filterEmployee">Employee</label>
                            <select id="filterEmployee" class="form-control">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="filterOutputAttendance()">Filter</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Employee Name</th>
                                    <th>Job Position</th>
                                    <th>Date</th>
                                    <th>Shift Code</th>
                                    <th>Check In</th>
                                    <th>Check Out</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="outputAttendanceTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            mainContent.innerHTML = content;
            
            // Populate employee filter
            if (isAdmin) {
                const filterEmployee = document.getElementById('filterEmployee');
                const nonAdminEmployees = employees.filter(emp => !emp.isAdmin);
                
                nonAdminEmployees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.fullName;
                    filterEmployee.appendChild(option);
                });
            }
            
            // Load output attendance table
            loadOutputAttendanceTable();
        }

        // Load output attendance table
        function loadOutputAttendanceTable(dateFrom = '', dateTo = '', employeeId = '') {
            const tableBody = document.getElementById('outputAttendanceTableBody');
            tableBody.innerHTML = '';
            
            // Filter attendance data
            let filteredAttendance = [...attendanceData];
            
            if (dateFrom) {
                filteredAttendance = filteredAttendance.filter(att => att.date >= dateFrom);
            }
            
            if (dateTo) {
                filteredAttendance = filteredAttendance.filter(att => att.date <= dateTo);
            }
            
            if (employeeId) {
                filteredAttendance = filteredAttendance.filter(att => att.employeeId === parseInt(employeeId));
            } else if (!isAdmin) {
                // Non-admin users can only see their own attendance
                filteredAttendance = filteredAttendance.filter(att => att.employeeId === currentUser.id);
            }
            
            // Sort by date (newest first)
            filteredAttendance.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Create table rows
            filteredAttendance.forEach(attendance => {
                const employee = employees.find(emp => emp.id === attendance.employeeId);
                
                if (!employee) return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.fullName}</td>
                    <td>${employee.jobPosition}</td>
                    <td>${formatDate(attendance.date)}</td>
                    <td><span class="badge ${getShiftClass(attendance.shiftCode)}">${getShiftName(attendance.shiftCode)}</span></td>
                    <td>${attendance.checkIn || '-'}</td>
                    <td>${attendance.checkOut || '-'}</td>
                    <td><span class="badge ${attendance.status === 'Hadir' ? 'badge-success' : 'badge-warning'}">${attendance.status}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            if (filteredAttendance.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" style="text-align: center;">No attendance data found</td>';
                tableBody.appendChild(row);
            }
        }

        // Filter output attendance
        function filterOutputAttendance() {
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const employeeId = isAdmin ? document.getElementById('filterEmployee').value : '';
            
            loadOutputAttendanceTable(dateFrom, dateTo, employeeId);
        }

        // Input Leave Page
        function showInputLeave() {
            pageTitle.textContent = 'Input Cuti';
            
            let content = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Input Cuti</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="leaveEmployee">Employee</label>
                            <select id="leaveEmployee" class="form-control">
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leaveStartDate">Start Date</label>
                            <input type="date" id="leaveStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="leaveEndDate">End Date</label>
                            <input type="date" id="leaveEndDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="leaveReason">Reason</label>
                            <textarea id="leaveReason" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="leaveStatus">Status</label>
                            <select id="leaveStatus" class="form-control">
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveLeave()">
                            <i class="fas fa-save"></i> Save Leave
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Leave List</h3>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Employee Name</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="leaveTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            mainContent.innerHTML = content;
            
            // Populate employee select
            const leaveEmployee = document.getElementById('leaveEmployee');
            const nonAdminEmployees = employees.filter(emp => !emp.isAdmin);
            
            nonAdminEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.fullName;
                leaveEmployee.appendChild(option);
            });
            
            // Load leave table
            loadLeaveTable();
        }

        // Load leave table
        function loadLeaveTable() {
            const tableBody = document.getElementById('leaveTableBody');
            tableBody.innerHTML = '';
            
            // Sort leave data by start date (newest first)
            const sortedLeaveData = [...leaveData].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            
            sortedLeaveData.forEach(leave => {
                const employee = employees.find(emp => emp.id === leave.employeeId);
                
                if (!employee) return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.fullName}</td>
                    <td>${formatDate(leave.startDate)}</td>
                    <td>${formatDate(leave.endDate)}</td>
                    <td>${leave.reason}</td>
                    <td><span class="badge ${leave.status === 'approved' ? 'badge-success' : leave.status === 'rejected' ? 'badge-danger' : 'badge-warning'}">${leave.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="editLeave(${leave.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteLeave(${leave.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            if (sortedLeaveData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center;">No leave data found</td>';
                tableBody.appendChild(row);
            }
        }

        // Save leave
        function saveLeave() {
            const employeeId = parseInt(document.getElementById('leaveEmployee').value);
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value;
            const status = document.getElementById('leaveStatus').value;
            
            if (!employeeId || !startDate || !endDate || !reason) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            // Add new leave
            const newLeave = {
                id: leaveData.length > 0 ? Math.max(...leaveData.map(l => l.id)) + 1 : 1,
                employeeId,
                startDate,
                endDate,
                reason,
                status
            };
            
            leaveData.push(newLeave);
            saveDataToStorage();
            
            // Reset form
            document.getElementById('leaveEmployee').value = '';
            document.getElementById('leaveStartDate').value = '';
            document.getElementById('leaveEndDate').value = '';
            document.getElementById('leaveReason').value = '';
            document.getElementById('leaveStatus').value = 'pending';
            
            loadLeaveTable();
            showToast('Leave saved successfully', 'success');
        }

        // Edit leave
        function editLeave(leaveId) {
            const leave = leaveData.find(l => l.id === leaveId);
            
            if (!leave) {
                showToast('Leave not found', 'error');
                return;
            }
            
            const employee = employees.find(emp => emp.id === leave.employeeId);
            
            // Create modal to edit leave
            const modalContent = `
                <div class="form-group">
                    <label>Employee</label>
                    <input type="text" class="form-control" value="${employee.fullName}" readonly>
                </div>
                <div class="form-group">
                    <label for="editLeaveStartDate">Start Date</label>
                    <input type="date" id="editLeaveStartDate" class="form-control" value="${leave.startDate}">
                </div>
                <div class="form-group">
                    <label for="editLeaveEndDate">End Date</label>
                    <input type="date" id="editLeaveEndDate" class="form-control" value="${leave.endDate}">
                </div>
                <div class="form-group">
                    <label for="editLeaveReason">Reason</label>
                    <textarea id="editLeaveReason" class="form-control" rows="3">${leave.reason}</textarea>
                </div>
                <div class="form-group">
                    <label for="editLeaveStatus">Status</label>
                    <select id="editLeaveStatus" class="form-control">
                        <option value="pending" ${leave.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="approved" ${leave.status === 'approved' ? 'selected' : ''}>Approved</option>
                        <option value="rejected" ${leave.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="updateLeave(${leave.id})">Update Leave</button>
            `;
            
            showModal('Edit Leave', modalContent);
        }

        // Update leave
        function updateLeave(leaveId) {
            const startDate = document.getElementById('editLeaveStartDate').value;
            const endDate = document.getElementById('editLeaveEndDate').value;
            const reason = document.getElementById('editLeaveReason').value;
            const status = document.getElementById('editLeaveStatus').value;
            
            // Find leave index
            const leaveIndex = leaveData.findIndex(l => l.id === leaveId);
            
            if (leaveIndex === -1) {
                showToast('Leave not found', 'error');
                return;
            }
            
            // Update leave
            leaveData[leaveIndex] = {
                ...leaveData[leaveIndex],
                startDate,
                endDate,
                reason,
                status
            };
            
            saveDataToStorage();
            
            closeModalHandler();
            loadLeaveTable();
            showToast('Leave updated successfully', 'success');
        }

        // Delete leave
        function deleteLeave(leaveId) {
            if (confirm('Are you sure you want to delete this leave?')) {
                // Find leave index
                const leaveIndex = leaveData.findIndex(l => l.id === leaveId);
                
                if (leaveIndex === -1) {
                    showToast('Leave not found', 'error');
                    return;
                }
                
                // Delete leave
                leaveData.splice(leaveIndex, 1);
                saveDataToStorage();
                
                loadLeaveTable();
                showToast('Leave deleted successfully', 'success');
            }
        }

        // Summary Leave Page
        function showSummaryLeave() {
            pageTitle.textContent = 'Summary Cuti';
            
            let content = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Summary Cuti</h3>
                    </div>
                    <div class="filter-container">
                        <div class="form-group">
                            <label for="summaryLeaveYear">Year</label>
                            <select id="summaryLeaveYear" class="form-control">
                                <option value="${new Date().getFullYear()}">${new Date().getFullYear()}</option>
                                <option value="${new Date().getFullYear() - 1}">${new Date().getFullYear() - 1}</option>
                                <option value="${new Date().getFullYear() - 2}">${new Date().getFullYear() - 2}</option>
                            </select>
                        </div>
                        ${isAdmin ? `
                        <div class="form-group">
                            <label for="summaryLeaveEmployee">Employee</label>
                            <select id="summaryLeaveEmployee" class="form-control">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="filterSummaryLeave()">Filter</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Employee Name</th>
                                    <th>Total Leave Days</th>
                                    <th>Approved</th>
                                    <th>Pending</th>
                                    <th>Rejected</th>
                                </tr>
                            </thead>
                            <tbody id="summaryLeaveTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            mainContent.innerHTML = content;
            
            // Populate employee filter
            if (isAdmin) {
                const summaryLeaveEmployee = document.getElementById('summaryLeaveEmployee');
                const nonAdminEmployees = employees.filter(emp => !emp.isAdmin);
                
                nonAdminEmployees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.fullName;
                    summaryLeaveEmployee.appendChild(option);
                });
            }
            
            // Load summary leave table
            loadSummaryLeaveTable();
        }

        // Load summary leave table
        function loadSummaryLeaveTable(year = '', employeeId = '') {
            const tableBody = document.getElementById('summaryLeaveTableBody');
            tableBody.innerHTML = '';
            
            // Get current year if not provided
            if (!year) {
                year = new Date().getFullYear();
            }
            
            // Get employees to summarize
            let employeesToSummarize = employees.filter(emp => !emp.isAdmin);
            
            if (employeeId) {
                employeesToSummarize = employeesToSummarize.filter(emp => emp.id === parseInt(employeeId));
            } else if (!isAdmin) {
                // Non-admin users can only see their own summary
                employeesToSummarize = employeesToSummarize.filter(emp => emp.id === currentUser.id);
            }
            
            // Calculate summary for each employee
            const summaryData = [];
            
            employeesToSummarize.forEach(employee => {
                // Get leave data for this employee in the selected year
                const employeeLeaveData = leaveData.filter(leave => {
                    const leaveYear = new Date(leave.startDate).getFullYear();
                    return leave.employeeId === employee.id && leaveYear === parseInt(year);
                });
                
                // Calculate totals
                let totalLeaveDays = 0;
                let approvedDays = 0;
                let pendingDays = 0;
                let rejectedDays = 0;
                
                employeeLeaveData.forEach(leave => {
                    const startDate = new Date(leave.startDate);
                    const endDate = new Date(leave.endDate);
                    const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                    
                    totalLeaveDays += days;
                    
                    if (leave.status === 'approved') {
                        approvedDays += days;
                    } else if (leave.status === 'pending') {
                        pendingDays += days;
                    } else if (leave.status === 'rejected') {
                        rejectedDays += days;
                    }
                });
                
                summaryData.push({
                    employee,
                    totalLeaveDays,
                    approvedDays,
                    pendingDays,
                    rejectedDays
                });
            });
            
            // Create table rows
            summaryData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.employee.fullName}</td>
                    <td>${data.totalLeaveDays}</td>
                    <td><span class="badge badge-success">${data.approvedDays}</span></td>
                    <td><span class="badge badge-warning">${data.pendingDays}</span></td>
                    <td><span class="badge badge-danger">${data.rejectedDays}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            if (summaryData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" style="text-align: center;">No leave data found</td>';
                tableBody.appendChild(row);
            }
        }

        // Filter summary leave
        function filterSummaryLeave() {
            const year = document.getElementById('summaryLeaveYear').value;
            const employeeId = isAdmin ? document.getElementById('summaryLeaveEmployee').value : '';
            
            loadSummaryLeaveTable(year, employeeId);
        }

        // Detail Attendance Page
        function showDetailAttendance() {
            pageTitle.textContent = 'Detail Absen';
            
            let content = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Detail Absen</h3>
                    </div>
                    <div class="filter-container">
                        <div class="form-group">
                            <label for="detailDateFrom">Date From</label>
                            <input type="date" id="detailDateFrom" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="detailDateTo">Date To</label>
                            <input type="date" id="detailDateTo" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="detailEmployee">Employee</label>
                            <select id="detailEmployee" class="form-control">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="filterDetailAttendance()">Filter</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Employee Name</th>
                                    <th>Job Position</th>
                                    <th>Date</th>
                                    <th>Shift Code</th>
                                    <th>Check In</th>
                                    <th>Check Out</th>
                                    <th>Status</th>
                                    <th>Working Hours</th>
                                </tr>
                            </thead>
                            <tbody id="detailAttendanceTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            mainContent.innerHTML = content;
            
            // Populate employee filter
            const detailEmployee = document.getElementById('detailEmployee');
            const nonAdminEmployees = employees.filter(emp => !emp.isAdmin);
            
            nonAdminEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.fullName;
                detailEmployee.appendChild(option);
            });
            
            // Load detail attendance table
            loadDetailAttendanceTable();
        }

        // Load detail attendance table
        function loadDetailAttendanceTable(dateFrom = '', dateTo = '', employeeId = '') {
            const tableBody = document.getElementById('detailAttendanceTableBody');
            tableBody.innerHTML = '';
            
            // Filter attendance data
            let filteredAttendance = [...attendanceData];
            
            if (dateFrom) {
                filteredAttendance = filteredAttendance.filter(att => att.date >= dateFrom);
            }
            
            if (dateTo) {
                filteredAttendance = filteredAttendance.filter(att => att.date <= dateTo);
            }
            
            if (employeeId) {
                filteredAttendance = filteredAttendance.filter(att => att.employeeId === parseInt(employeeId));
            }
            
            // Sort by date (newest first)
            filteredAttendance.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Create table rows
            filteredAttendance.forEach(attendance => {
                const employee = employees.find(emp => emp.id === attendance.employeeId);
                
                if (!employee) return;
                
                // Calculate working hours
                let workingHours = '-';
                
                if (attendance.checkIn && attendance.checkOut) {
                    const checkIn = new Date(`2000-01-01T${attendance.checkIn}`);
                    const checkOut = new Date(`2000-01-01T${attendance.checkOut}`);
                    
                    // Handle overnight shifts
                    if (checkOut < checkIn) {
                        checkOut.setDate(checkOut.getDate() + 1);
                    }
                    
                    const diffMs = checkOut - checkIn;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    
                    workingHours = `${diffHours}h ${diffMinutes}m`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.fullName}</td>
                    <td>${employee.jobPosition}</td>
                    <td>${formatDate(attendance.date)}</td>
                    <td><span class="badge ${getShiftClass(attendance.shiftCode)}">${getShiftName(attendance.shiftCode)}</span></td>
                    <td>${attendance.checkIn || '-'}</td>
                    <td>${attendance.checkOut || '-'}</td>
                    <td><span class="badge ${attendance.status === 'Hadir' ? 'badge-success' : 'badge-warning'}">${attendance.status}</span></td>
                    <td>${workingHours}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            if (filteredAttendance.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" style="text-align: center;">No attendance data found</td>';
                tableBody.appendChild(row);
            }
        }

        // Filter detail attendance
        function filterDetailAttendance() {
            const dateFrom = document.getElementById('detailDateFrom').value;
            const dateTo = document.getElementById('detailDateTo').value;
            const employeeId = document.getElementById('detailEmployee').value;
            
            loadDetailAttendanceTable(dateFrom, dateTo, employeeId);
        }

        // Overtime Form Page
        function showOvertimeForm() {
            pageTitle.textContent = 'Overtime Form';
            
            let content = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Overtime Form</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Employee Name</label>
                            <input type="text" class="form-control" value="${currentUser.fullName}" readonly>
                        </div>
                        <div class="form-group">
                            <label for="overtimeDate">Date</label>
                            <input type="date" id="overtimeDate" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label for="overtimeStartTime">Start Time</label>
                            <input type="time" id="overtimeStartTime" class="form-control" value="17:00">
                        </div>
                        <div class="form-group">
                            <label for="overtimeEndTime">End Time</label>
                            <input type="time" id="overtimeEndTime" class="form-control" value="21:00">
                        </div>
                        <div class="form-group">
                            <label for="totalProject">Total Project</label>
                            <input type="number" id="totalProject" class="form-control" value="0">
                        </div>
                        <div class="form-group">
                            <label for="totalPlant">Total Plant</label>
                            <input type="number" id="totalPlant" class="form-control" value="0">
                        </div>
                        <div class="form-group">
                            <label for="plantName">Plant Name</label>
                            <select id="plantName" class="form-control">
                                <option value="Denpasar2">Denpasar2</option>
                                <option value="Gianyar">Gianyar</option>
                                <option value="Manukan">Manukan</option>
                                <option value="Manyar">Manyar</option>
                                <option value="Kediri">Kediri</option>
                                <option value="Krian">Krian</option>
                                <option value="Gempol">Gempol</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="totalVolume">Total Volume</label>
                            <input type="number" id="totalVolume" class="form-control" value="0">
                        </div>
                        <div class="form-group">
                            <label for="taskDescription">Task Description</label>
                            <textarea id="taskDescription" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveOvertime()">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Overtime History</h3>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Total Project</th>
                                    <th>Total Plant</th>
                                    <th>Plant Name</th>
                                    <th>Total Volume</th>
                                    <th>Task Description</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="overtimeTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            mainContent.innerHTML = content;
            
            // Load overtime table
            loadOvertimeTable();
        }

        // Load overtime table
        function loadOvertimeTable() {
            const tableBody = document.getElementById('overtimeTableBody');
            tableBody.innerHTML = '';
            
            // Get user's overtime data
            const userOvertimeData = overtimeData.filter(ot => ot.employeeId === currentUser.id);
            
            // Sort by date (newest first)
            userOvertimeData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Create table rows
            userOvertimeData.forEach(overtime => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(overtime.date)}</td>
                    <td>${overtime.startTime}</td>
                    <td>${overtime.endTime}</td>
                    <td>${overtime.totalProject}</td>
                    <td>${overtime.totalPlant}</td>
                    <td>${overtime.plantName}</td>
                    <td>${overtime.totalVolume}</td>
                    <td>${overtime.taskDescription}</td>
                    <td><span class="badge ${overtime.status === 'approved' ? 'badge-success' : overtime.status === 'rejected' ? 'badge-danger' : 'badge-warning'}">${overtime.status}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            if (userOvertimeData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="9" style="text-align: center;">No overtime data found</td>';
                tableBody.appendChild(row);
            }
        }

        // Save overtime
        function saveOvertime() {
            const date = document.getElementById('overtimeDate').value;
            const startTime = document.getElementById('overtimeStartTime').value;
            const endTime = document.getElementById('overtimeEndTime').value;
            const totalProject = document.getElementById('totalProject').value;
            const totalPlant = document.getElementById('totalPlant').value;
            const plantName = document.getElementById('plantName').value;
            const totalVolume = document.getElementById('totalVolume').value;
            const taskDescription = document.getElementById('taskDescription').value;
            
            if (!date || !startTime || !endTime || !taskDescription) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            // Calculate total overtime hours
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            
            // Handle overnight
            if (end < start) {
                end.setDate(end.getDate() + 1);
            }
            
            const diffMs = end - start;
            const diffHours = diffMs / (1000 * 60 * 60);
            
            // Add new overtime
            const newOvertime = {
                id: overtimeData.length > 0 ? Math.max(...overtimeData.map(o => o.id)) + 1 : 1,
                employeeId: currentUser.id,
                date,
                startTime,
                endTime,
                totalProject: parseFloat(totalProject) || 0,
                totalPlant: parseFloat(totalPlant) || 0,
                plantName,
                totalVolume: parseFloat(totalVolume) || 0,
                taskDescription,
                status: 'pending'
            };
            
            overtimeData.push(newOvertime);
            saveDataToStorage();
            
            // Update overtime calculation
            updateOvertimeCalculation(currentUser.id, date, diffHours, taskDescription);
            
            // Reset form
            document.getElementById('overtimeDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('overtimeStartTime').value = '17:00';
            document.getElementById('overtimeEndTime').value = '21:00';
            document.getElementById('totalProject').value = '0';
            document.getElementById('totalPlant').value = '0';
            document.getElementById('plantName').value = 'Denpasar2';
            document.getElementById('totalVolume').value = '0';
            document.getElementById('taskDescription').value = '';
            
            loadOvertimeTable();
            showToast('Overtime saved successfully', 'success');
        }

        // Update overtime calculation
        function updateOvertimeCalculation(employeeId, date, overtimeHours, taskDescription) {
            // Find attendance for the employee and date
            const attendance = attendanceData.find(att => 
                att.employeeId === employeeId && att.date === date
            );
            
            if (!attendance) {
                return;
            }
            
            // Check if overtime calculation already exists
            const existingCalcIndex = overtimeCalcData.findIndex(calc => 
                calc.attendanceId === attendance.id
            );
            
            if (existingCalcIndex !== -1) {
                // Update existing calculation
                overtimeCalcData[existingCalcIndex] = {
                    ...overtimeCalcData[existingCalcIndex],
                    rkpPic: overtimeHours,
                    remark: taskDescription
                };
            } else {
                // Add new calculation
                const newCalc = {
                    id: overtimeCalcData.length > 0 ? Math.max(...overtimeCalcData.map(c => c.id)) + 1 : 1,
                    attendanceId: attendance.id,
                    actualShiftIn: '',
                    actualShiftOut: '',
                    overtime: 0,
                    checkRmc: '',
                    rkpPic: overtimeHours,
                    rmcShiftCheckIn: '',
                    remark: taskDescription
                };
                
                overtimeCalcData.push(newCalc);
            }
            
            saveDataToStorage();
        }

        // Overtime Detail Page
        function showOvertimeDetail() {
            pageTitle.textContent = 'Overtime Detail';
            
            let content = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Overtime Detail</h3>
                    </div>
                    <div class="filter-container">
                        <div class="form-group">
                            <label for="overtimeDetailDateFrom">Date From</label>
                            <input type="date" id="overtimeDetailDateFrom" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="overtimeDetailDateTo">Date To</label>
                            <input type="date" id="overtimeDetailDateTo" class="form-control">
                        </div>
                        ${isAdmin ? `
                        <div class="form-group">
                            <label for="overtimeDetailEmployee">Employee</label>
                            <select id="overtimeDetailEmployee" class="form-control">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="filterOvertimeDetail()">Filter</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Employee Name</th>
                                    <th>Date</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Total Project</th>
                                    <th>Total Plant</th>
                                    <th>Plant Name</th>
                                    <th>Total Volume</th>
                                    <th>Task Description</th>
                                    <th>Status</th>
                                    ${isAdmin ? '<th>Action</th>' : ''}
                                </tr>
                            </thead>
                            <tbody id="overtimeDetailTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            mainContent.innerHTML = content;
            
            // Populate employee filter
            if (isAdmin) {
                const overtimeDetailEmployee = document.getElementById('overtimeDetailEmployee');
                const nonAdminEmployees = employees.filter(emp => !emp.isAdmin);
                
                nonAdminEmployees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.fullName;
                    overtimeDetailEmployee.appendChild(option);
                });
            }
            
            // Load overtime detail table
            loadOvertimeDetailTable();
        }

        // Load overtime detail table
        function loadOvertimeDetailTable(dateFrom = '', dateTo = '', employeeId = '') {
            const tableBody = document.getElementById('overtimeDetailTableBody');
            tableBody.innerHTML = '';
            
            // Filter overtime data
            let filteredOvertime = [...overtimeData];
            
            if (dateFrom) {
                filteredOvertime = filteredOvertime.filter(ot => ot.date >= dateFrom);
            }
            
            if (dateTo) {
                filteredOvertime = filteredOvertime.filter(ot => ot.date <= dateTo);
            }
            
            if (employeeId) {
                filteredOvertime = filteredOvertime.filter(ot => ot.employeeId === parseInt(employeeId));
            } else if (!isAdmin) {
                // Non-admin users can only see their own overtime
                filteredOvertime = filteredOvertime.filter(ot => ot.employeeId === currentUser.id);
            }
            
            // Sort by date (newest first)
            filteredOvertime.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Create table rows
            filteredOvertime.forEach(overtime => {
                const employee = employees.find(emp => emp.id === overtime.employeeId);
                
                if (!employee) return;
                
                const row = document.createElement('tr');
                
                let actionCell = '';
                if (isAdmin) {
                    actionCell = `
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="editOvertimeStatus(${overtime.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteOvertime(${overtime.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                }
                
                row.innerHTML = `
                    <td>${employee.fullName}</td>
                    <td>${formatDate(overtime.date)}</td>
                    <td>${overtime.startTime}</td>
                    <td>${overtime.endTime}</td>
                    <td>${overtime.totalProject}</td>
                    <td>${overtime.totalPlant}</td>
                    <td>${overtime.plantName}</td>
                    <td>${overtime.totalVolume}</td>
                    <td>${overtime.taskDescription}</td>
                    <td><span class="badge ${overtime.status === 'approved' ? 'badge-success' : overtime.status === 'rejected' ? 'badge-danger' : 'badge-warning'}">${overtime.status}</span></td>
                    ${actionCell}
                `;
                
                tableBody.appendChild(row);
            });
            
            if (filteredOvertime.length === 0) {
                const colspan = isAdmin ? 11 : 10;
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="${colspan}" style="text-align: center;">No overtime data found</td>`;
                tableBody.appendChild(row);
            }
        }

        // Filter overtime detail
        function filterOvertimeDetail() {
            const dateFrom = document.getElementById('overtimeDetailDateFrom').value;
            const dateTo = document.getElementById('overtimeDetailDateTo').value;
            const employeeId = isAdmin ? document.getElementById('overtimeDetailEmployee').value : '';
            
            loadOvertimeDetailTable(dateFrom, dateTo, employeeId);
        }

        // Edit overtime status
        function editOvertimeStatus(overtimeId) {
            const overtime = overtimeData.find(ot => ot.id === overtimeId);
            
            if (!overtime) {
                showToast('Overtime not found', 'error');
                return;
            }
            
            const employee = employees.find(emp => emp.id === overtime.employeeId);
            
            // Create modal to edit overtime status
            const modalContent = `
                <div class="form-group">
                    <label>Employee</label>
                    <input type="text" class="form-control" value="${employee.fullName}" readonly>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="text" class="form-control" value="${formatDate(overtime.date)}" readonly>
                </div>
                <div class="form-group">
                    <label>Task Description</label>
                    <textarea class="form-control" rows="3" readonly>${overtime.taskDescription}</textarea>
                </div>
                <div class="form-group">
                    <label for="editOvertimeStatus">Status</label>
                    <select id="editOvertimeStatus" class="form-control">
                        <option value="pending" ${overtime.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="approved" ${overtime.status === 'approved' ? 'selected' : ''}>Approved</option>
                        <option value="rejected" ${overtime.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="updateOvertimeStatus(${overtime.id})">Update Status</button>
            `;
            
            showModal('Edit Overtime Status', modalContent);
        }

        // Update overtime status
        function updateOvertimeStatus(overtimeId) {
            const status = document.getElementById('editOvertimeStatus').value;
            
            // Find overtime index
            const overtimeIndex = overtimeData.findIndex(ot => ot.id === overtimeId);
            
            if (overtimeIndex === -1) {
                showToast('Overtime not found', 'error');
                return;
            }
            
            // Update overtime status
            overtimeData[overtimeIndex] = {
                ...overtimeData[overtimeIndex],
                status
            };
            
            saveDataToStorage();
            
            closeModalHandler();
            loadOvertimeDetailTable();
            showToast('Overtime status updated successfully', 'success');
        }

        // Delete overtime
        function deleteOvertime(overtimeId) {
            if (confirm('Are you sure you want to delete this overtime?')) {
                // Find overtime index
                const overtimeIndex = overtimeData.findIndex(ot => ot.id === overtimeId);
                
                if (overtimeIndex === -1) {
                    showToast('Overtime not found', 'error');
                    return;
                }
                
                // Delete overtime
                overtimeData.splice(overtimeIndex, 1);
                saveDataToStorage();
                
                loadOvertimeDetailTable();
                showToast('Overtime deleted successfully', 'success');
            }
        }

        // Overtime Calculation Page
        function showOvertimeCalculation() {
            pageTitle.textContent = 'Overtime Calculation';
            
            let content = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Overtime Calculation</h3>
                    </div>
                    <div class="filter-container">
                        <div class="form-group">
                            <label for="calcDateFrom">Date From</label>
                            <input type="date" id="calcDateFrom" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="calcDateTo">Date To</label>
                            <input type="date" id="calcDateTo" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="calcEmployee">Employee</label>
                            <select id="calcEmployee" class="form-control">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="filterOvertimeCalculation()">Filter</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Employee Name</th>
                                    <th>Date</th>
                                    <th>Shift Code</th>
                                    <th>Actual Shift In</th>
                                    <th>Actual Shift Out</th>
                                    <th>Overtime</th>
                                    <th>Check RMC</th>
                                    <th>RKP PIC</th>
                                    <th>RMC - Shift Check In</th>
                                    <th>Remark</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="overtimeCalcTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            mainContent.innerHTML = content;
            
            // Populate employee filter
            const calcEmployee = document.getElementById('calcEmployee');
            const nonAdminEmployees = employees.filter(emp => !emp.isAdmin);
            
            nonAdminEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.fullName;
                calcEmployee.appendChild(option);
            });
            
            // Load overtime calculation table
            loadOvertimeCalculationTable();
        }

        // Load overtime calculation table
        function loadOvertimeCalculationTable(dateFrom = '', dateTo = '', employeeId = '') {
            const tableBody = document.getElementById('overtimeCalcTableBody');
            tableBody.innerHTML = '';
            
            // Get attendance data with overtime calculation
            let attendanceWithCalc = [];
            
            attendanceData.forEach(attendance => {
                const employee = employees.find(emp => emp.id === attendance.employeeId);
                
                if (!employee) return;
                
                // Find overtime calculation for this attendance
                const calc = overtimeCalcData.find(c => c.attendanceId === attendance.id);
                
                attendanceWithCalc.push({
                    attendance,
                    employee,
                    calc
                });
            });
            
            // Filter data
            if (dateFrom) {
                attendanceWithCalc = attendanceWithCalc.filter(item => item.attendance.date >= dateFrom);
            }
            
            if (dateTo) {
                attendanceWithCalc = attendanceWithCalc.filter(item => item.attendance.date <= dateTo);
            }
            
            if (employeeId) {
                attendanceWithCalc = attendanceWithCalc.filter(item => item.attendance.employeeId === parseInt(employeeId));
            }
            
            // Sort by date (newest first)
            attendanceWithCalc.sort((a, b) => new Date(b.attendance.date) - new Date(a.attendance.date));
            
            // Create table rows
            attendanceWithCalc.forEach(item => {
                const { attendance, employee, calc } = item;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.fullName}</td>
                    <td>${formatDate(attendance.date)}</td>
                    <td><span class="badge ${getShiftClass(attendance.shiftCode)}">${getShiftName(attendance.shiftCode)}</span></td>
                    <td>${calc ? calc.actualShiftIn : '-'}</td>
                    <td>${calc ? calc.actualShiftOut : '-'}</td>
                    <td>${calc ? calc.overtime : '-'}</td>
                    <td>${calc ? calc.checkRmc : '-'}</td>
                    <td>${calc ? calc.rkpPic : '-'}</td>
                    <td>${calc ? calc.rmcShiftCheckIn : '-'}</td>
                    <td>${calc ? calc.remark : '-'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editOvertimeCalculation(${attendance.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            if (attendanceWithCalc.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="11" style="text-align: center;">No overtime calculation data found</td>';
                tableBody.appendChild(row);
            }
        }

        // Filter overtime calculation
        function filterOvertimeCalculation() {
            const dateFrom = document.getElementById('calcDateFrom').value;
            const dateTo = document.getElementById('calcDateTo').value;
            const employeeId = document.getElementById('calcEmployee').value;
            
            loadOvertimeCalculationTable(dateFrom, dateTo, employeeId);
        }

        // Edit overtime calculation
        function editOvertimeCalculation(attendanceId) {
            const attendance = attendanceData.find(att => att.id === attendanceId);
            
            if (!attendance) {
                showToast('Attendance not found', 'error');
                return;
            }
            
            const employee = employees.find(emp => emp.id === attendance.employeeId);
            
            // Find overtime calculation for this attendance
            const calc = overtimeCalcData.find(c => c.attendanceId === attendanceId);
            
            // Create modal to edit overtime calculation
            const modalContent = `
                <div class="form-group">
                    <label>Employee</label>
                    <input type="text" class="form-control" value="${employee.fullName}" readonly>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="text" class="form-control" value="${formatDate(attendance.date)}" readonly>
                </div>
                <div class="form-group">
                    <label>Shift Code</label>
                    <input type="text" class="form-control" value="${getShiftName(attendance.shiftCode)}" readonly>
                </div>
                <div class="form-group">
                    <label for="editActualShiftIn">Actual Shift In</label>
                    <input type="time" id="editActualShiftIn" class="form-control" value="${calc ? calc.actualShiftIn : ''}">
                </div>
                <div class="form-group">
                    <label for="editActualShiftOut">Actual Shift Out</label>
                    <input type="time" id="editActualShiftOut" class="form-control" value="${calc ? calc.actualShiftOut : ''}">
                </div>
                <div class="form-group">
                    <label for="editOvertime">Overtime</label>
                    <input type="number" id="editOvertime" class="form-control" step="0.1" value="${calc ? calc.overtime : 0}">
                </div>
                <div class="form-group">
                    <label for="editCheckRmc">Check RMC</label>
                    <input type="text" id="editCheckRmc" class="form-control" value="${calc ? calc.checkRmc : ''}">
                </div>
                <div class="form-group">
                    <label>RKP PIC</label>
                    <input type="text" class="form-control" value="${calc ? calc.rkpPic : '-'}" readonly>
                </div>
                <div class="form-group">
                    <label for="editRmcShiftCheckIn">RMC - Shift Check In</label>
                    <input type="text" id="editRmcShiftCheckIn" class="form-control" value="${calc ? calc.rmcShiftCheckIn : ''}">
                </div>
                <div class="form-group">
                    <label>Remark</label>
                    <textarea class="form-control" rows="3" readonly>${calc ? calc.remark : ''}</textarea>
                </div>
                <button class="btn btn-primary" onclick="updateOvertimeCalculation(${attendanceId})">Update Calculation</button>
            `;
            
            showModal('Edit Overtime Calculation', modalContent);
        }

        // Update overtime calculation
        function updateOvertimeCalculation(attendanceId) {
            const actualShiftIn = document.getElementById('editActualShiftIn').value;
            const actualShiftOut = document.getElementById('editActualShiftOut').value;
            const overtime = document.getElementById('editOvertime').value;
            const checkRmc = document.getElementById('editCheckRmc').value;
            const rmcShiftCheckIn = document.getElementById('editRmcShiftCheckIn').value;
            
            // Find overtime calculation index
            const calcIndex = overtimeCalcData.findIndex(c => c.attendanceId === attendanceId);
            
            if (calcIndex !== -1) {
                // Update existing calculation
                overtimeCalcData[calcIndex] = {
                    ...overtimeCalcData[calcIndex],
                    actualShiftIn,
                    actualShiftOut,
                    overtime: parseFloat(overtime) || 0,
                    checkRmc,
                    rmcShiftCheckIn
                };
            } else {
                // Add new calculation
                const newCalc = {
                    id: overtimeCalcData.length > 0 ? Math.max(...overtimeCalcData.map(c => c.id)) + 1 : 1,
                    attendanceId,
                    actualShiftIn,
                    actualShiftOut,
                    overtime: parseFloat(overtime) || 0,
                    checkRmc,
                    rkpPic: 0,
                    rmcShiftCheckIn,
                    remark: ''
                };
                
                overtimeCalcData.push(newCalc);
            }
            
            saveDataToStorage();
            
            closeModalHandler();
            loadOvertimeCalculationTable();
            showToast('Overtime calculation updated successfully', 'success');
        }

        // Summary Overtime Page
        function showSummaryOvertime() {
            pageTitle.textContent = 'Summary Overtime';
            
            let content = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Summary Overtime</h3>
                    </div>
                    <div class="filter-container">
                        <div class="form-group">
                            <label for="summaryOvertimeMonth">Month</label>
                            <select id="summaryOvertimeMonth" class="form-control">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="summaryOvertimeYear">Year</label>
                            <select id="summaryOvertimeYear" class="form-control">
                                <option value="${new Date().getFullYear()}">${new Date().getFullYear()}</option>
                                <option value="${new Date().getFullYear() - 1}">${new Date().getFullYear() - 1}</option>
                                <option value="${new Date().getFullYear() - 2}">${new Date().getFullYear() - 2}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="summaryOvertimeEmployee">Employee</label>
                            <select id="summaryOvertimeEmployee" class="form-control">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="filterSummaryOvertime()">Filter</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Employee Name</th>
                                    <th>Total Overtime Hours</th>
                                    <th>Approved</th>
                                    <th>Pending</th>
                                    <th>Rejected</th>
                                </tr>
                            </thead>
                            <tbody id="summaryOvertimeTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            mainContent.innerHTML = content;
            
            // Set current month and year
            document.getElementById('summaryOvertimeMonth').value = new Date().getMonth() + 1;
            
            // Populate employee filter
            const summaryOvertimeEmployee = document.getElementById('summaryOvertimeEmployee');
            const nonAdminEmployees = employees.filter(emp => !emp.isAdmin);
            
            nonAdminEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.fullName;
                summaryOvertimeEmployee.appendChild(option);
            });
            
            // Load summary overtime table
            loadSummaryOvertimeTable();
        }

        // Load summary overtime table
        function loadSummaryOvertimeTable(month = '', year = '', employeeId = '') {
            const tableBody = document.getElementById('summaryOvertimeTableBody');
            tableBody.innerHTML = '';
            
            // Get current month and year if not provided
            if (!month) {
                month = new Date().getMonth() + 1;
            }
            
            if (!year) {
                year = new Date().getFullYear();
            }
            
            // Get employees to summarize
            let employeesToSummarize = employees.filter(emp => !emp.isAdmin);
            
            if (employeeId) {
                employeesToSummarize = employeesToSummarize.filter(emp => emp.id === parseInt(employeeId));
            }
            
            // Calculate summary for each employee
            const summaryData = [];
            
            employeesToSummarize.forEach(employee => {
                // Get overtime calculation data for this employee in the selected month and year
                const employeeOvertimeCalc = overtimeCalcData.filter(calc => {
                    const attendance = attendanceData.find(att => att.id === calc.attendanceId);
                    if (!attendance) return false;
                    
                    const attendanceDate = new Date(attendance.date);
                    return attendance.employeeId === employee.id && 
                           attendanceDate.getMonth() + 1 === parseInt(month) && 
                           attendanceDate.getFullYear() === parseInt(year);
                });
                
                // Calculate totals
                let totalOvertime = 0;
                let approvedOvertime = 0;
                let pendingOvertime = 0;
                let rejectedOvertime = 0;
                
                employeeOvertimeCalc.forEach(calc => {
                    totalOvertime += parseFloat(calc.overtime) || 0;
                    
                    // Get overtime status
                    const attendance = attendanceData.find(att => att.id === calc.attendanceId);
                    if (attendance) {
                        const overtime = overtimeData.find(ot => 
                            ot.employeeId === attendance.employeeId && ot.date === attendance.date
                        );
                        
                        if (overtime) {
                            if (overtime.status === 'approved') {
                                approvedOvertime += parseFloat(calc.overtime) || 0;
                            } else if (overtime.status === 'pending') {
                                pendingOvertime += parseFloat(calc.overtime) || 0;
                            } else if (overtime.status === 'rejected') {
                                rejectedOvertime += parseFloat(calc.overtime) || 0;
                            }
                        }
                    }
                });
                
                summaryData.push({
                    employee,
                    totalOvertime,
                    approvedOvertime,
                    pendingOvertime,
                    rejectedOvertime
                });
            });
            
            // Create table rows
            summaryData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.employee.fullName}</td>
                    <td>${data.totalOvertime.toFixed(1)} hours</td>
                    <td><span class="badge badge-success">${data.approvedOvertime.toFixed(1)} hours</span></td>
                    <td><span class="badge badge-warning">${data.pendingOvertime.toFixed(1)} hours</span></td>
                    <td><span class="badge badge-danger">${data.rejectedOvertime.toFixed(1)} hours</span></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            if (summaryData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" style="text-align: center;">No overtime data found</td>';
                tableBody.appendChild(row);
            }
        }

        // Filter summary overtime
        function filterSummaryOvertime() {
            const month = document.getElementById('summaryOvertimeMonth').value;
            const year = document.getElementById('summaryOvertimeYear').value;
            const employeeId = document.getElementById('summaryOvertimeEmployee').value;
            
            loadSummaryOvertimeTable(month, year, employeeId);
        }

        // Management App Page
        function showManagementApp() {
            pageTitle.textContent = 'Management Aplikasi';
            
            let content = `
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('userManagement')">User Management</div>
                    <div class="tab" onclick="switchTab('passwordUpdates')">Password Updates</div>
                </div>
                
                <div id="userManagement" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">User Management</h3>
                            <button class="btn btn-primary btn-sm" onclick="addUser()">
                                <i class="fas fa-plus"></i> Add User
                            </button>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Full Name</th>
                                        <th>Job Position</th>
                                        <th>Is Admin</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="userTableBody">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="passwordUpdates" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Password Updates</h3>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Password Updated</th>
                                        <th>New Password</th>
                                    </tr>
                                </thead>
                                <tbody id="passwordTableBody">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            mainContent.innerHTML = content;
            
            // Load user table
            loadUserTable();
            
            // Load password updates table
            loadPasswordUpdatesTable();
        }

        // Switch tab
        function switchTab(tabName) {
            // Update tab buttons
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            // Update tab content
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
        }

        // Load user table
        function loadUserTable() {
            const tableBody = document.getElementById('userTableBody');
            tableBody.innerHTML = '';
            
            // Create table rows
            employees.forEach(employee => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.username}</td>
                    <td>${employee.fullName}</td>
                    <td>${employee.jobPosition}</td>
                    <td>${employee.isAdmin ? 'Yes' : 'No'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="editUser(${employee.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${employee.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="resetPassword(${employee.id})">
                                <i class="fas fa-key"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Load password updates table
        function loadPasswordUpdatesTable() {
            const tableBody = document.getElementById('passwordTableBody');
            tableBody.innerHTML = '';
            
            // Sort app settings by password updated date (newest first)
            const sortedSettings = [...appSettings].sort((a, b) => 
                new Date(b.passwordUpdated) - new Date(a.passwordUpdated)
            );
            
            // Create table rows
            sortedSettings.forEach(setting => {
                const employee = employees.find(emp => emp.id === setting.userId);
                
                if (!employee) return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.fullName}</td>
                    <td>${new Date(setting.passwordUpdated).toLocaleString()}</td>
                    <td>${setting.newPassword}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            if (sortedSettings.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="3" style="text-align: center;">No password update data found</td>';
                tableBody.appendChild(row);
            }
        }

        // Add user
        function addUser() {
            const modalContent = `
                <div class="form-group">
                    <label for="newUsername">Username</label>
                    <input type="text" id="newUsername" class="form-control">
                </div>
                <div class="form-group">
                    <label for="newPassword">Password</label>
                    <input type="password" id="newPassword" class="form-control">
                </div>
                <div class="form-group">
                    <label for="newFullName">Full Name</label>
                    <input type="text" id="newFullName" class="form-control">
                </div>
                <div class="form-group">
                    <label for="newJobPosition">Job Position</label>
                    <select id="newJobPosition" class="form-control">
                        <option value="Dispatcher">Dispatcher</option>
                        <option value="Booking">Booking</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newIsAdmin"> Is Admin
                    </label>
                </div>
                <button class="btn btn-primary" onclick="saveNewUser()">Add User</button>
            `;
            
            showModal('Add New User', modalContent);
        }

        // Save new user
        function saveNewUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const fullName = document.getElementById('newFullName').value;
            const jobPosition = document.getElementById('newJobPosition').value;
            const isAdmin = document.getElementById('newIsAdmin').checked;
            
            if (!username || !password || !fullName || !jobPosition) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            // Check if username already exists
            if (employees.some(emp => emp.username === username)) {
                showToast('Username already exists', 'error');
                return;
            }
            
            // Add new user
            const newUser = {
                id: employees.length > 0 ? Math.max(...employees.map(e => e.id)) + 1 : 1,
                username,
                password,
                fullName,
                jobPosition,
                isAdmin
            };
            
            employees.push(newUser);
            saveDataToStorage();
            
            closeModalHandler();
            loadUserTable();
            showToast('User added successfully', 'success');
        }

        // Edit user
        function editUser(userId) {
            const user = employees.find(emp => emp.id === userId);
            
            if (!user) {
                showToast('User not found', 'error');
                return;
            }
            
            const modalContent = `
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-control" value="${user.username}" readonly>
                </div>
                <div class="form-group">
                    <label for="editFullName">Full Name</label>
                    <input type="text" id="editFullName" class="form-control" value="${user.fullName}">
                </div>
                <div class="form-group">
                    <label for="editJobPosition">Job Position</label>
                    <select id="editJobPosition" class="form-control">
                        <option value="Dispatcher" ${user.jobPosition === 'Dispatcher' ? 'selected' : ''}>Dispatcher</option>
                        <option value="Booking" ${user.jobPosition === 'Booking' ? 'selected' : ''}>Booking</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editIsAdmin" ${user.isAdmin ? 'checked' : ''}> Is Admin
                    </label>
                </div>
                <button class="btn btn-primary" onclick="updateUser(${user.id})">Update User</button>
            `;
            
            showModal('Edit User', modalContent);
        }

        // Update user
        function updateUser(userId) {
            const fullName = document.getElementById('editFullName').value;
            const jobPosition = document.getElementById('editJobPosition').value;
            const isAdmin = document.getElementById('editIsAdmin').checked;
            
            // Find user index
            const userIndex = employees.findIndex(emp => emp.id === userId);
            
            if (userIndex === -1) {
                showToast('User not found', 'error');
                return;
            }
            
            // Update user
            employees[userIndex] = {
                ...employees[userIndex],
                fullName,
                jobPosition,
                isAdmin
            };
            
            saveDataToStorage();
            
            closeModalHandler();
            loadUserTable();
            showToast('User updated successfully', 'success');
        }

        // Delete user
        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                // Find user index
                const userIndex = employees.findIndex(emp => emp.id === userId);
                
                if (userIndex === -1) {
                    showToast('User not found', 'error');
                    return;
                }
                
                // Delete user
                employees.splice(userIndex, 1);
                saveDataToStorage();
                
                loadUserTable();
                showToast('User deleted successfully', 'success');
            }
        }

        // Reset password
        function resetPassword(userId) {
            const user = employees.find(emp => emp.id === userId);
            
            if (!user) {
                showToast('User not found', 'error');
                return;
            }
            
            const newPassword = prompt(`Enter new password for ${user.fullName}:`);
            
            if (!newPassword) {
                return;
            }
            
            // Update user password
            const userIndex = employees.findIndex(emp => emp.id === userId);
            employees[userIndex].password = newPassword;
            
            // Add password update record
            const newSetting = {
                id: appSettings.length > 0 ? Math.max(...appSettings.map(s => s.id)) + 1 : 1,
                userId: userId,
                passwordUpdated: new Date().toISOString(),
                newPassword: newPassword
            };
            
            appSettings.push(newSetting);
            saveDataToStorage();
            
            loadUserTable();
            loadPasswordUpdatesTable();
            showToast('Password reset successfully', 'success');
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
