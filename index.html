<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Crew CDC East</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* Semua style CSS tetap sama seperti sebelumnya */
        /* ... (CSS yang sama) ... */
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar Backdrop for Mobile -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus"></div>

    <!-- Loading Spinner -->
    <div class="spinner-container" id="loadingSpinner" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <h2 class="login-title">ATTENDANCE CREW CDC EAST</h2>
            <div class="offline-message" id="loginOfflineMessage">
                <i class="fas fa-wifi"></i> You are currently offline. Some features may be limited.
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" placeholder="Enter email">
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" placeholder="Enter password">
            </div>
            <div class="login-error" id="loginError">Email or password is incorrect!</div>
            <button class="btn btn-futuristic w-100" id="loginBtn">Login</button>
            <div class="provider-text">Provide by L23-51Xe</div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Attendance Menu</h3>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <!-- General Folder (User & Admin) -->
        <div class="sidebar-folder" id="generalFolder">
            <div class="sidebar-folder-header">
                <i class="fas fa-folder"></i>
                <span>General</span>
            </div>
            <div class="sidebar-folder-content">
                <ul class="sidebar-menu">
                    <li>
                        <a href="#" data-tab="absen-tabel">
                            <i class="fas fa-table"></i>
                            <span>Attendance Table</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-tab="cuti-detail">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Summarize Leave</span>
                        </a>
                    </li>
                    <!-- Menu Overtime Form hanya untuk user biasa -->
                    <li id="overtimeFormMenuItem" style="display: none;">
                        <a href="#" data-tab="form-rekap-lembur">
                            <i class="fas fa-calculator"></i>
                            <span>Overtime Form</span>
                        </a>
                    </li>
                    <!-- Menu Overtime Detail untuk admin -->
                    <li id="overtimeDetailMenuItem" style="display: none;">
                        <a href="#" data-tab="overtime-detail-admin">
                            <i class="fas fa-list-alt"></i>
                            <span>Overtime Detail</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Main Folder (Admin Only) -->
        <div class="sidebar-folder" id="mainFolder">
            <div class="sidebar-folder-header">
                <i class="fas fa-folder"></i>
                <span>Main</span>
            </div>
            <div class="sidebar-folder-content">
                <ul class="sidebar-menu">
                    <li>
                        <a href="#" data-tab="entry">
                            <i class="fas fa-pen-to-square"></i>
                            <span>Attendance Entry</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-tab="output">
                            <i class="fas fa-file-export"></i>
                            <span>Attendance Output</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-tab="overtime">
                            <i class="fas fa-calculator"></i>
                            <span>Overtime Calculation</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-tab="cuti">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Leave Management</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-tab="summary-overtime">
                            <i class="fas fa-chart-bar"></i>
                            <span>Summary Overtime</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Settings Menu (Admin Only) -->
        <ul class="sidebar-menu">
            <li>
                <a href="#" data-tab="setting">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
            <li>
                <a href="#" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- User Password Section -->
    <div class="user-password-section" id="userPasswordSection">
        <button class="user-password-btn" id="changePasswordSidebarBtn">
            <i class="fas fa-key"></i>
            <span>Change Password</span>
        </button>
    </div>

    <!-- Header -->
    <header class="futuristic-header">
        <div class="container">
            <h1 class="header-title text-center">ATTENDANCE CREW CDC EAST</h1>
            <p class="header-subtitle text-center">Modern and Efficient Attendance Management</p>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="offline-message" id="appOfflineMessage">
            <i class="fas fa-wifi"></i> You are currently offline. Data will be synced when connection is restored.
        </div>
        
        <div class="container mt-4">
            <!-- Filter Section for Main Folder -->
            <div class="filter-section filter-section-main" id="filterSectionMain">
                <h6>Main Folder Filter</h6>
                <div class="row g-2">
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="dateRangeMain" class="form-label">Date Range</label>
                        <div class="input-group input-group-sm">
                            <input type="date" class="form-control" id="startDateMain">
                            <span class="input-group-text">to</span>
                            <input type="date" class="form-control" id="endDateMain">
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-4" id="employeeFilterContainerMain">
                        <label for="employeeNameMain" class="form-label">Employee Name</label>
                        <select class="form-select form-select-sm" id="employeeNameMain">
                            <option value="all">Select All</option>
                            <!-- Options will be filled by JavaScript -->
                        </select>
                    </div>
                    <div class="col-12 col-lg-4 d-flex align-items-end gap-2">
                        <button class="btn btn-futuristic btn-sm flex-fill" id="applyFilterMain">
                            <i class="fas fa-filter me-1"></i> Apply Filter
                        </button>
                        <button class="btn btn-load-data btn-sm flex-fill" id="loadDataMain">
                            <i class="fas fa-download me-1"></i> Load Data
                        </button>
                        <button class="btn btn-futuristic btn-sm flex-fill" id="exportExcelMain">
                            <i class="fas fa-file-excel me-1"></i> Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- PERBAIKAN: Filter Section untuk Overtime Calculation dan Attendance Output -->
            <div class="filter-section filter-section-overtime-output" id="filterSectionOvertimeOutput" style="display: none;">
                <h6>Overtime & Output Filter</h6>
                <div class="row g-2">
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="dateRangeOvertimeOutput" class="form-label">Date Range</label>
                        <div class="input-group input-group-sm">
                            <input type="date" class="form-control" id="startDateOvertimeOutput">
                            <span class="input-group-text">to</span>
                            <input type="date" class="form-control" id="endDateOvertimeOutput">
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-4" id="employeeFilterContainerOvertimeOutput">
                        <label for="employeeNameOvertimeOutput" class="form-label">Employee Name</label>
                        <select class="form-select form-select-sm" id="employeeNameOvertimeOutput">
                            <option value="all">Select All</option>
                            <!-- Options will be filled by JavaScript -->
                        </select>
                    </div>
                    <div class="col-12 col-lg-4 d-flex align-items-end gap-2">
                        <button class="btn btn-futuristic btn-sm flex-fill" id="applyFilterOvertimeOutput">
                            <i class="fas fa-filter me-1"></i> Apply Filter
                        </button>
                        <button class="btn btn-load-data btn-sm flex-fill" id="loadDataOvertimeOutput">
                            <i class="fas fa-download me-1"></i> Load Data
                        </button>
                        <button class="btn btn-futuristic btn-sm flex-fill" id="exportExcelOvertimeOutput">
                            <i class="fas fa-file-excel me-1"></i> Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- PERBAIKAN: Filter Section untuk Attendance Table -->
            <div class="filter-section filter-section-absen-tabel" id="filterSectionAbsenTabel" style="display: none;">
                <h6>Attendance Table Filter</h6>
                <div class="row g-2">
                    <div class="col-12 col-md-6 col-lg-4">
                        <label for="dateRangeAbsenTabel" class="form-label">Date Range</label>
                        <div class="input-group input-group-sm">
                            <input type="date" class="form-control" id="startDateAbsenTabel">
                            <span class="input-group-text">to</span>
                            <input type="date" class="form-control" id="endDateAbsenTabel">
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-4" id="employeeFilterContainerAbsenTabel">
                        <label for="employeeNameAbsenTabel" class="form-label">Employee Name</label>
                        <select class="form-select form-select-sm" id="employeeNameAbsenTabel">
                            <option value="all">Select All</option>
                            <!-- Options will be filled by JavaScript -->
                        </select>
                    </div>
                    <div class="col-12 col-lg-4 d-flex align-items-end gap-2">
                        <button class="btn btn-futuristic btn-sm flex-fill" id="applyFilterAbsenTabel">
                            <i class="fas fa-filter me-1"></i> Apply Filter
                        </button>
                        <button class="btn btn-load-data btn-sm flex-fill" id="loadDataAbsenTabel">
                            <i class="fas fa-download me-1"></i> Load Data
                        </button>
                        <button class="btn btn-futuristic btn-sm flex-fill" id="exportExcelAbsenTabel">
                            <i class="fas fa-file-excel me-1"></i> Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="tab-content" id="absensiTabContent">
                <!-- Entry Tab -->
                <div class="tab-pane fade show active" id="entry" role="tabpanel">
                    <!-- Konten Entry Tab -->
                </div>

                <!-- Output Tab -->
                <div class="tab-pane fade" id="output" role="tabpanel">
                    <!-- Konten Output Tab -->
                </div>

                <!-- Overtime Tab -->
                <div class="tab-pane fade" id="overtime" role="tabpanel">
                    <!-- Konten Overtime Tab -->
                </div>

                <!-- Absen Tabel Tab -->
                <div class="tab-pane fade" id="absen-tabel" role="tabpanel">
                    <!-- Konten Absen Tabel Tab -->
                </div>

                <!-- Cuti Tab -->
                <div class="tab-pane fade" id="cuti" role="tabpanel">
                    <!-- Konten Cuti Tab -->
                </div>

                <!-- Cuti Detail Tab -->
                <div class="tab-pane fade" id="cuti-detail" role="tabpanel">
                    <!-- Konten Cuti Detail Tab -->
                </div>

                <!-- Form Rekap Lembur Tab -->
                <div class="tab-pane fade" id="form-rekap-lembur" role="tabpanel">
                    <!-- Konten Form Rekap Lembur Tab -->
                </div>

                <!-- Overtime Detail Admin Tab -->
                <div class="tab-pane fade" id="overtime-detail-admin" role="tabpanel">
                    <!-- Konten Overtime Detail Admin Tab -->
                </div>

                <!-- Summary Overtime Tab -->
                <div class="tab-pane fade" id="summary-overtime" role="tabpanel">
                    <!-- Konten Summary Overtime Tab -->
                </div>

                <!-- Setting Tab -->
                <div class="tab-pane fade" id="setting" role="tabpanel">
                    <!-- Konten Setting Tab -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal untuk Tambah Pengguna -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <!-- Konten Modal -->
    </div>

    <!-- Modal untuk Edit Pengguna -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <!-- Konten Modal -->
    </div>

    <!-- Modal untuk Ganti Password (User) -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <!-- Konten Modal -->
    </div>

    <!-- Modal untuk View Leave Details -->
    <div class="modal fade leave-detail-modal" id="viewLeaveDetailModal" tabindex="-1" aria-labelledby="viewLeaveDetailModalLabel" aria-hidden="true">
        <!-- Konten Modal -->
    </div>

    <!-- Modal untuk Edit Overtime Detail -->
    <div class="modal fade" id="editOvertimeDetailModal" tabindex="-1" aria-labelledby="editOvertimeDetailModalLabel" aria-hidden="true">
        <!-- Konten Modal -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCs_65P_SLx529UwLcQO8cF69yD1yLOgKY",
            authDomain: "blueiiifirebase.firebaseapp.com",
            projectId: "blueiiifirebase",
            storageBucket: "blueiiifirebase.firebasestorage.app",
            messagingSenderId: "194236727932",
            appId: "1:194236727932:web:6b10d6302d5c56ebac3ff9"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Enable offline persistence
        db.enablePersistence()
          .catch((err) => {
              console.log('Persistence failed: ', err);
          });

        // Data matrik untuk shift
        const shiftMatrix = {
            "Dispatcher": {
                "1": { name: "Morning", checkIn: "07:00", checkOut: "15:00", hours: "07:00" },
                "2": { name: "Afternoon", checkIn: "15:00", checkOut: "23:00", hours: "07:00" },
                "3": { name: "Night", checkIn: "23:00", checkOut: "07:00", hours: "08:00" },
                "11": { name: "Morning Part", checkIn: "07:00", checkOut: "12:00", hours: "05:00" },
                "22": { name: "Afternoon Part", checkIn: "15:00", checkOut: "20:00", hours: "05:00" },
                "C": { name: "Leave", checkIn: "", checkOut: "", hours: "" },
                "O": { name: "Off", checkIn: "", checkOut: "", hours: "" }
            },
            "Booking": {
                "1": { name: "Morning", checkIn: "08:00", checkOut: "16:00", hours: "07:00" },
                "2": { name: "Afternoon", checkIn: "16:00", checkOut: "24:00", hours: "08:00" },
                "3": { name: "Night", checkIn: "00:00", checkOut: "08:00", hours: "08:00" },
                "11": { name: "Morning Part", checkIn: "08:00", checkOut: "13:00", hours: "05:00" },
                "22": { name: "Afternoon Part", checkIn: "16:00", checkOut: "21:00", hours: "05:00" },
                "C": { name: "Leave", checkIn: "", checkOut: "", hours: "" },
                "O": { name: "Off", checkIn: "", checkOut: "", hours: "" }
            }
        };

        // Data awal karyawan
        const initialEmployees = [
            { area: "CDC East", name: "Fahmi Ardiansah", position: "Dispatcher" },
            { area: "CDC East", name: "Agung Setyawan", position: "Dispatcher" },
            { area: "CDC East", name: "Drajat Triono", position: "Dispatcher" },
            { area: "CDC East", name: "Wiyanto", position: "Dispatcher" },
            { area: "CDC East", name: "Nur Fauziah", position: "Booking" }
        ];

        // Variabel global
        let absensiData = [];
        let absenTabelData = [];
        let outputData = [];
        let overtimeCalcData = [];
        let dateRangeMain = [];
        let dateRangeOvertimeOutput = [];
        let dateRangeAbsenTabel = [];
        let currentTab = "entry";
        let users = [];
        let cutiData = [];
        let cutiDetailData = [];
        let currentUser = null;
        let rekapLemburData = [];
        let isOnline = navigator.onLine;
        let currentFocusedCell = null;
        let isSaving = false;
        let outputDataLoaded = false;
        let overtimeDataLoaded = false;

        // PERBAIKAN: Variabel untuk sorting di overtime calculation
        let overtimeSortColumn = 'date';
        let overtimeSortDirection = 'asc';

        // =============================================
        // PERBAIKAN UTAMA: FUNGSI UNTUK OVERTIME CALCULATION
        // =============================================

        // PERBAIKAN: Fungsi untuk memuat data overtime calculation dengan filter
        async function loadOvertimeCalculationData() {
            try {
                showLoading(true);
                
                // Reset data
                overtimeCalcData = [];
                
                // Dapatkan filter date range
                const startDate = document.getElementById('startDateOvertimeOutput').valueAsDate;
                const endDate = document.getElementById('endDateOvertimeOutput').valueAsDate;
                
                if (!startDate || !endDate) {
                    console.log('No date range selected for overtime calculation');
                    return;
                }
                
                // Format tanggal untuk query
                const startDateStr = formatDateForShift(startDate);
                const endDateStr = formatDateForShift(endDate);
                
                console.log('Loading overtime data for range:', startDateStr, 'to', endDateStr);
                
                // Query data overtime dalam rentang tanggal
                const querySnapshot = await db.collection('overtime')
                    .where('date', '>=', startDateStr)
                    .where('date', '<=', endDateStr)
                    .get();
                
                querySnapshot.forEach(doc => {
                    overtimeCalcData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`Loaded ${overtimeCalcData.length} overtime records for period`);
                
                // Update tabel overtime calculation
                updateOvertimeTable();
                
            } catch (error) {
                console.error('Error loading overtime calculation data:', error);
                showNotification('Error loading overtime calculation data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // PERBAIKAN: Fungsi untuk update overtime calculation table dengan filter
        function updateOvertimeTable() {
            const tbody = document.querySelector('#overtimeTableBody');
            if (!tbody) {
                console.log('Overtime table body not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            // PERBAIKAN: Filter data berdasarkan date range Overtime & Output
            const startDateOvertimeOutput = document.getElementById('startDateOvertimeOutput').valueAsDate;
            const endDateOvertimeOutput = document.getElementById('endDateOvertimeOutput').valueAsDate;
            const employeeFilterOvertimeOutput = document.getElementById('employeeNameOvertimeOutput').value;
            
            console.log('Filtering overtime data with:', {
                startDate: startDateOvertimeOutput,
                endDate: endDateOvertimeOutput,
                employeeFilter: employeeFilterOvertimeOutput,
                totalData: overtimeCalcData.length
            });
            
            let filteredOvertimeData = overtimeCalcData.filter(data => {
                const dataDate = parseDateFromString(data.date);
                const dateInRange = (!startDateOvertimeOutput || !endDateOvertimeOutput) || 
                                  (dataDate >= startDateOvertimeOutput && dataDate <= endDateOvertimeOutput);
                const employeeMatch = employeeFilterOvertimeOutput === 'all' || data.name === employeeFilterOvertimeOutput;
                
                return dateInRange && employeeMatch;
            });
            
            console.log(`Filtered to ${filteredOvertimeData.length} records`);
            
            // PERBAIKAN: Urutkan data berdasarkan kolom dan arah yang dipilih
            filteredOvertimeData = sortOvertimeData(filteredOvertimeData, overtimeSortColumn, overtimeSortDirection);
            
            if (filteredOvertimeData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="16" class="text-center">No overtime data found for the selected filter</td>`;
                tbody.appendChild(row);
                return;
            }
            
            let no = 1;
            filteredOvertimeData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${no++}</td>
                    <td>${data.area}</td>
                    <td>${data.name}</td>
                    <td>${data.position}</td>
                    <td>${data.date}</td>
                    <td>${data.shift}</td>
                    <td>${data.shiftCheckIn}</td>
                    <td>${data.shiftCheckOut}</td>
                    <td>${data.wtNormal}</td>
                    <td><input type="time" class="actual-check-in" value="${data.actualCheckIn || ''}" data-id="${data.id}"></td>
                    <td><input type="time" class="actual-check-out" value="${data.actualCheckOut || ''}" data-id="${data.id}"></td>
                    <td><input type="text" class="over-time" value="${data.overTime || ''}" data-id="${data.id}" readonly></td>
                    <td><input type="text" class="cek-rmc" value="${data.cekRMC || ''}" data-id="${data.id}"></td>
                    <td><input type="text" class="rkp-pic" value="${data.rkpPIC || ''}" data-id="${data.id}"></td>
                    <td><input type="text" class="rmc-shift-check-out" value="${data.rmcShiftCheckOut || ''}" data-id="${data.id}" readonly></td>
                    <td><input type="text" class="remarks-input" value="${data.remarks || ''}" data-id="${data.id}"></td>
                `;
                tbody.appendChild(row);
            });
            
            // PERBAIKAN: Add event listeners untuk perhitungan otomatis
            document.querySelectorAll('.actual-check-out').forEach(input => {
                input.addEventListener('change', function() {
                    calculateOvertime(this);
                });
            });
            
            // PERBAIKAN: Update icon sorting
            updateSortIcons();
            
            // Update overtime summary jika di tab yang sesuai
            if (currentTab === 'summary-overtime') {
                updateOvertimeSummaryTable();
            }
        }

        // PERBAIKAN: Fungsi untuk apply filter tanggal Overtime & Output
        async function applyDateFilterOvertimeOutput() {
            const startDate = document.getElementById('startDateOvertimeOutput').valueAsDate;
            const endDate = document.getElementById('endDateOvertimeOutput').valueAsDate;
            
            if (!startDate || !endDate) {
                showNotification('Please select both start and end dates', 'error');
                return;
            }
            
            dateRangeOvertimeOutput = [];
            let currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                dateRangeOvertimeOutput.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Batasi maksimal 31 hari untuk performa
            if (dateRangeOvertimeOutput.length > 31) {
                alert('Date range limited to 31 days for better performance');
                dateRangeOvertimeOutput = dateRangeOvertimeOutput.slice(0, 31);
                document.getElementById('endDateOvertimeOutput').valueAsDate = dateRangeOvertimeOutput[dateRangeOvertimeOutput.length - 1];
            }
            
            console.log('Applying overtime output filter for range:', startDate, 'to', endDate);
            
            // Load data untuk periode yang difilter
            await loadOvertimeCalculationData();
            
            // Juga update output table jika di tab output
            if (currentTab === 'output') {
                updateOutputTable();
            }
        }

        // =============================================
        // PERBAIKAN: FUNGSI UNTUK ATTENDANCE OUTPUT
        // =============================================

        // PERBAIKAN: Fungsi untuk memuat data output dengan filter
        async function loadOutputData() {
            try {
                showLoading(true);
                
                // Reset data
                outputData = [];
                
                // Dapatkan filter date range
                const startDate = document.getElementById('startDateOvertimeOutput').valueAsDate;
                const endDate = document.getElementById('endDateOvertimeOutput').valueAsDate;
                
                if (!startDate || !endDate) {
                    console.log('No date range selected for output data');
                    return;
                }
                
                // Format tanggal untuk query
                const startDateStr = formatDateForShift(startDate);
                const endDateStr = formatDateForShift(endDate);
                
                console.log('Loading output data for range:', startDateStr, 'to', endDateStr);
                
                // Query data attendance dalam rentang tanggal
                const querySnapshot = await db.collection('attendance')
                    .where('date', '>=', startDateStr)
                    .where('date', '<=', endDateStr)
                    .get();
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    // Get shift details from shiftMatrix
                    const shiftDetails = shiftMatrix[data.position] && shiftMatrix[data.position][data.shift];
                    
                    if (shiftDetails) {
                        outputData.push({
                            id: doc.id,
                            area: data.area,
                            name: data.name,
                            position: data.position,
                            date: data.date,
                            shift: shiftDetails.name,
                            shiftCheckIn: shiftDetails.checkIn,
                            shiftCheckOut: shiftDetails.checkOut,
                            remarks: data.remarks || ""
                        });
                    }
                });
                
                console.log(`Loaded ${outputData.length} output records for period`);
                
                // Update tabel output
                updateOutputTable();
                
            } catch (error) {
                console.error('Error loading output data:', error);
                showNotification('Error loading output data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // PERBAIKAN: Fungsi untuk update output table dengan filter
        function updateOutputTable() {
            const tbody = document.querySelector('#outputTable tbody');
            if (!tbody) {
                console.log('Output table body not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            // PERBAIKAN: Filter data berdasarkan date range Overtime & Output
            const startDateOvertimeOutput = document.getElementById('startDateOvertimeOutput').valueAsDate;
            const endDateOvertimeOutput = document.getElementById('endDateOvertimeOutput').valueAsDate;
            const employeeFilterOvertimeOutput = document.getElementById('employeeNameOvertimeOutput').value;
            
            console.log('Filtering output data with:', {
                startDate: startDateOvertimeOutput,
                endDate: endDateOvertimeOutput,
                employeeFilter: employeeFilterOvertimeOutput,
                totalData: outputData.length
            });
            
            let filteredOutputData = outputData.filter(data => {
                const dataDate = parseDateFromString(data.date);
                const dateInRange = (!startDateOvertimeOutput || !endDateOvertimeOutput) || 
                                  (dataDate >= startDateOvertimeOutput && dataDate <= endDateOvertimeOutput);
                const employeeMatch = employeeFilterOvertimeOutput === 'all' || data.name === employeeFilterOvertimeOutput;
                
                return dateInRange && employeeMatch;
            });
            
            console.log(`Filtered to ${filteredOutputData.length} records`);
            
            // PERBAIKAN: Urutkan data berdasarkan tanggal
            filteredOutputData.sort((a, b) => {
                const dateA = parseDateFromString(a.date);
                const dateB = parseDateFromString(b.date);
                return dateA - dateB;
            });
            
            if (filteredOutputData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="8" class="text-center">No attendance data found for the selected filter</td>`;
                tbody.appendChild(row);
                return;
            }
            
            filteredOutputData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.area}</td>
                    <td>${data.name}</td>
                    <td>${data.position}</td>
                    <td>${data.date}</td>
                    <td>${data.shift}</td>
                    <td>${data.shiftCheckIn}</td>
                    <td>${data.shiftCheckOut}</td>
                    <td><input type="text" class="remarks-input" value="${data.remarks}" data-id="${data.id}"></td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listener for remarks input
            document.querySelectorAll('.remarks-input').forEach(input => {
                input.addEventListener('change', function() {
                    const dataId = this.getAttribute('data-id');
                    const remarks = this.value;
                    
                    // Find the item in outputData and update remarks
                    const item = outputData.find(d => d.id === dataId);
                    if (item) {
                        item.remarks = remarks;
                    }
                });
            });
        }

        // =============================================
        // PERBAIKAN: ATTENDANCE SUMMARY FUNCTIONS
        // =============================================

        // PERBAIKAN: Function to generate attendance summary data yang akurat
        function generateAttendanceSummary() {
            const summaryData = {};
            
            // Process each employee in absenTabelData yang sedang ditampilkan
            const displayedEmployees = absenTabelData;
            
            displayedEmployees.forEach(employee => {
                if (!employee.name) return;
                
                // Initialize employee summary if not exists
                if (!summaryData[employee.name]) {
                    summaryData[employee.name] = {
                        name: employee.name,
                        off: 0,
                        morning: 0,
                        afternoon: 0,
                        night: 0,
                        morningPart: 0,
                        afternoonPart: 0,
                        leave: 0,
                        totalAttendance: 0,
                        totalWorkDay: 0
                    };
                }
                
                // Count shifts for this employee hanya dari data yang ditampilkan
                if (employee.shifts) {
                    Object.values(employee.shifts).forEach(shiftCode => {
                        const shift = shiftCode.toUpperCase();
                        
                        switch(shift) {
                            case 'O':
                                summaryData[employee.name].off++;
                                summaryData[employee.name].totalWorkDay++; // O dihitung sebagai hari
                                break;
                            case '1':
                                summaryData[employee.name].morning++;
                                summaryData[employee.name].totalWorkDay++;
                                summaryData[employee.name].totalAttendance++;
                                break;
                            case '2':
                                summaryData[employee.name].afternoon++;
                                summaryData[employee.name].totalWorkDay++;
                                summaryData[employee.name].totalAttendance++;
                                break;
                            case '3':
                                summaryData[employee.name].night++;
                                summaryData[employee.name].totalWorkDay++;
                                summaryData[employee.name].totalAttendance++;
                                break;
                            case '11':
                                summaryData[employee.name].morningPart++;
                                summaryData[employee.name].totalWorkDay++;
                                summaryData[employee.name].totalAttendance++;
                                break;
                            case '22':
                                summaryData[employee.name].afternoonPart++;
                                summaryData[employee.name].totalWorkDay++;
                                summaryData[employee.name].totalAttendance++;
                                break;
                            case 'C':
                                summaryData[employee.name].leave++;
                                summaryData[employee.name].totalWorkDay++; // Cuti dihitung sebagai hari
                                break;
                            default:
                                // Untuk shift yang tidak dikenal, tidak dihitung
                                break;
                        }
                    });
                }
            });
            
            return Object.values(summaryData);
        }

        // PERBAIKAN: Function untuk validasi dan koreksi data attendance summary
        function validateAttendanceSummary() {
            const summaryData = generateAttendanceSummary();
            
            summaryData.forEach(employee => {
                console.log(`Validasi data untuk ${employee.name}:`, {
                    totalWorkDay: employee.totalWorkDay,
                    totalAttendance: employee.totalAttendance,
                    sumShifts: employee.off + employee.morning + employee.afternoon + 
                              employee.night + employee.morningPart + employee.afternoonPart + employee.leave
                });
                
                // Validasi: totalWorkDay harus sama dengan jumlah semua shift
                const calculatedTotal = employee.off + employee.morning + employee.afternoon + 
                                      employee.night + employee.morningPart + employee.afternoonPart + employee.leave;
                
                if (employee.totalWorkDay !== calculatedTotal) {
                    console.warn(`Data tidak konsisten untuk ${employee.name}: totalWorkDay=${employee.totalWorkDay}, calculated=${calculatedTotal}`);
                    // Koreksi otomatis
                    employee.totalWorkDay = calculatedTotal;
                }
                
                // Validasi: totalAttendance harus <= totalWorkDay
                if (employee.totalAttendance > employee.totalWorkDay) {
                    console.warn(`Total attendance melebihi total work day untuk ${employee.name}`);
                    employee.totalAttendance = employee.totalWorkDay;
                }
            });
            
            return summaryData;
        }

        // PERBAIKAN: Function to update attendance summary table dengan validasi
        function updateAttendanceSummaryTable() {
            const tbody = document.getElementById('attendanceSummaryTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Gunakan fungsi validasi
            const summaryData = validateAttendanceSummary();
            
            if (summaryData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="11" class="text-center">No attendance data available</td>`;
                tbody.appendChild(row);
                return;
            }
            
            // Sort employees by default order
            const sortedData = sortEmployeesByDefaultOrder(summaryData);
            
            sortedData.forEach((employee, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${employee.name}</td>
                    <td>${employee.off}</td>
                    <td>${employee.morning}</td>
                    <td>${employee.afternoon}</td>
                    <td>${employee.night}</td>
                    <td>${employee.morningPart}</td>
                    <td>${employee.afternoonPart}</td>
                    <td>${employee.leave}</td>
                    <td>${employee.totalAttendance}</td>
                    <td>${employee.totalWorkDay}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // =============================================
        // FUNGSI BANTU YANG DIPERLUKAN
        // =============================================

        // Fungsi untuk sorting data overtime
        function sortOvertimeData(data, column, direction) {
            return [...data].sort((a, b) => {
                let aValue = a[column];
                let bValue = b[column];
                
                // Handle special cases for different data types
                if (column === 'date') {
                    aValue = parseDateFromString(aValue);
                    bValue = parseDateFromString(bValue);
                } else if (column === 'no') {
                    // No sorting for number column
                    return 0;
                }
                
                // Handle empty values
                if (aValue === undefined || aValue === null) aValue = '';
                if (bValue === undefined || bValue === null) bValue = '';
                
                // Compare values
                if (aValue < bValue) {
                    return direction === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }

        // Fungsi untuk update icon sorting
        function updateSortIcons() {
            // Reset all icons
            document.querySelectorAll('.sortable-header .sort-icon').forEach(icon => {
                icon.innerHTML = '<i class="fas fa-sort"></i>';
                icon.classList.remove('active');
            });
            
            // Set active icon
            const activeHeader = document.querySelector(`.sortable-header[data-column="${overtimeSortColumn}"] .sort-icon`);
            if (activeHeader) {
                if (overtimeSortDirection === 'asc') {
                    activeHeader.innerHTML = '<i class="fas fa-sort-up"></i>';
                } else {
                    activeHeader.innerHTML = '<i class="fas fa-sort-down"></i>';
                }
                activeHeader.classList.add('active');
            }
        }

        // Fungsi untuk menghitung overtime
        function calculateOvertime(input) {
            const row = input.closest('tr');
            const shiftCheckOut = row.querySelector('td:nth-child(8)').textContent;
            const actualCheckOut = row.querySelector('.actual-check-out').value;
            
            if (actualCheckOut && shiftCheckOut) {
                const actualOut = new Date(`2000-01-01T${actualCheckOut}`);
                const shiftOut = new Date(`2000-01-01T${shiftCheckOut}`);
                
                // Jika actual check out di hari berikutnya (setelah tengah malam)
                if (actualOut < shiftOut) {
                    actualOut.setDate(actualOut.getDate() + 1);
                }
                
                const diffMs = actualOut - shiftOut;
                const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                
                const overtime = `${String(diffHrs).padStart(2, '0')}:${String(diffMins).padStart(2, '0')}`;
                row.querySelector('.over-time').value = overtime;
                
                // Update data
                const dataId = input.getAttribute('data-id');
                if (dataId) {
                    const item = overtimeCalcData.find(d => d.id === dataId);
                    if (item) {
                        item.overTime = overtime;
                    }
                }
            }
            
            // Hitung Rmc - Shift Check Out
            const cekRMC = row.querySelector('.cek-rmc').value;
            if (cekRMC && shiftCheckOut) {
                const rmcTime = new Date(`2000-01-01T${cekRMC}`);
                const shiftOutTime = new Date(`2000-01-01T${shiftCheckOut}`);
                
                // Jika RMC di hari berikutnya (setelah tengah malam)
                if (rmcTime < shiftOutTime) {
                    rmcTime.setDate(rmcTime.getDate() + 1);
                }
                
                const diffMs = rmcTime - shiftOutTime;
                const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                
                const rmcDiff = `${String(diffHrs).padStart(2, '0')}:${String(diffMins).padStart(2, '0')}`;
                row.querySelector('.rmc-shift-check-out').value = rmcDiff;
                
                // Update data
                const dataId = input.getAttribute('data-id');
                if (dataId) {
                    const item = overtimeCalcData.find(d => d.id === dataId);
                    if (item) {
                        item.rmcShiftCheckOut = rmcDiff;
                    }
                }
            }
        }

        // Fungsi untuk mengurutkan karyawan sesuai urutan default
        function sortEmployeesByDefaultOrder(employees) {
            const nameOrder = ["Fahmi Ardiansah", "Agung Setyawan", "Drajat Triono", "Wiyanto", "Nur Fauziah"];
            const sorted = [...employees];
            sorted.sort((a, b) => {
                const orderA = nameOrder.indexOf(a.name);
                const orderB = nameOrder.indexOf(b.name);
                return (orderA === -1 ? 999 : orderA) - (orderB === -1 ? 999 : orderB);
            });
            return sorted;
        }

        // Fungsi format tanggal
        function formatDateForShift(date) {
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
        }

        function formatDateForHeader(date) {
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = dayNames[date.getDay()];
            return `${dayName} ${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;
        }

        // Fungsi untuk parse tanggal dari string
        function parseDateFromString(dateStr) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return null;
        }

        // Fungsi untuk menampilkan notifikasi
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Show/hide loading spinner
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
        }

        // =============================================
        // EVENT LISTENERS UTAMA YANG DIPERBAIKI
        // =============================================

        // Event listeners untuk filter Overtime & Output
        document.getElementById('applyFilterOvertimeOutput').addEventListener('click', async function() {
            await applyDateFilterOvertimeOutput();
        });

        document.getElementById('loadDataOvertimeOutput').addEventListener('click', async function() {
            // PERBAIKAN: Load data yang sesuai dengan tab yang aktif
            if (currentTab === 'output') {
                await loadOutputData();
            } else if (currentTab === 'overtime') {
                await loadOvertimeCalculationData();
            } else if (currentTab === 'form-rekap-lembur' || currentTab === 'overtime-detail-admin') {
                // Untuk tab overtime form dan detail, load data overtime records
                await loadAllOvertimeData();
            }
        });

        // Event listener untuk sorting di overtime table
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.getAttribute('data-column');
                
                if (overtimeSortColumn === column) {
                    // Toggle direction if same column
                    overtimeSortDirection = overtimeSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // New column, default to ascending
                    overtimeSortColumn = column;
                    overtimeSortDirection = 'asc';
                }
                
                updateOvertimeTable();
            });
        });

        // Event listener untuk tab change
        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('expanded');
                    document.getElementById('mainContent').classList.toggle('expanded');
                    document.body.classList.toggle('header-expanded');
                    document.getElementById('userPasswordSection').classList.toggle('expanded');
                });
            }
            
            // Folder toggle
            document.querySelectorAll('.sidebar-folder-header').forEach(header => {
                header.addEventListener('click', function() {
                    this.parentElement.classList.toggle('expanded');
                });
            });
            
            // Menu item clicks - PERBAIKAN: Handle tab switching dengan benar
            document.querySelectorAll('.sidebar-menu a[data-tab]').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update active menu
                    document.querySelectorAll('.sidebar-menu a').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding tab
                    const tabName = this.getAttribute('data-tab');
                    currentTab = tabName;
                    
                    document.querySelectorAll('.tab-pane').forEach(tab => {
                        tab.classList.remove('show', 'active');
                    });
                    
                    const targetTab = document.getElementById(tabName);
                    if (targetTab) {
                        targetTab.classList.add('show', 'active');
                    }
                    
                    // PERBAIKAN: Tampilkan/sembunyikan filter yang sesuai
                    if (tabName === 'entry' || tabName === 'cuti' || tabName === 'summary-overtime') {
                        // Main folder tabs
                        document.getElementById('filterSectionMain').style.display = 'block';
                        document.getElementById('filterSectionOvertimeOutput').style.display = 'none';
                        document.getElementById('filterSectionAbsenTabel').style.display = 'none';
                    } else if (tabName === 'output' || tabName === 'overtime' || tabName === 'form-rekap-lembur' || tabName === 'overtime-detail-admin') {
                        // Overtime & Output tabs
                        document.getElementById('filterSectionMain').style.display = 'none';
                        document.getElementById('filterSectionOvertimeOutput').style.display = 'block';
                        document.getElementById('filterSectionAbsenTabel').style.display = 'none';
                        
                        // PERBAIKAN: Load data yang sesuai saat beralih tab
                        if (tabName === 'output') {
                            if (!outputDataLoaded) {
                                loadOutputData();
                                outputDataLoaded = true;
                            }
                        } else if (tabName === 'overtime') {
                            if (!overtimeDataLoaded) {
                                loadOvertimeCalculationData();
                                overtimeDataLoaded = true;
                            }
                        }
                    } else if (tabName === 'absen-tabel' || tabName === 'cuti-detail') {
                        // Attendance Table tabs
                        document.getElementById('filterSectionMain').style.display = 'none';
                        document.getElementById('filterSectionOvertimeOutput').style.display = 'none';
                        document.getElementById('filterSectionAbsenTabel').style.display = 'block';
                    } else if (tabName === 'setting') {
                        document.getElementById('filterSectionMain').style.display = 'none';
                        document.getElementById('filterSectionOvertimeOutput').style.display = 'none';
                        document.getElementById('filterSectionAbsenTabel').style.display = 'none';
                    }
                    
                    // Load data berdasarkan tab yang aktif
                    if (tabName === 'absen-tabel') {
                        updateAbsenTabelTable();
                        updateAttendanceSummaryTable();
                    }
                    
                    // Load overtime summary when switching to that tab
                    if (tabName === 'summary-overtime') {
                        updateOvertimeSummaryTable();
                    }
                    
                    // Load cuti detail data when switching to cuti-detail tab
                    if (tabName === 'cuti-detail') {
                        generateCutiDetailData();
                    }
                    
                    // Load cuti data when switching to cuti tab
                    if (tabName === 'cuti') {
                        updateCutiTable();
                    }
                    
                    // Initialize overtime form when switching to that tab
                    if (tabName === 'form-rekap-lembur') {
                        initOvertimeForm();
                    }
                    
                    // Initialize overtime detail admin when switching to that tab
                    if (tabName === 'overtime-detail-admin') {
                        initOvertimeDetailAdmin();
                    }
                });
            });
        }

        // =============================================
        // FUNGSI LAIN YANG DIPERLUKAN
        // =============================================

        // Fungsi untuk memuat data overtime records (untuk admin)
        async function loadAllOvertimeData() {
            try {
                const querySnapshot = await db.collection('overtimeRecords')
                    .orderBy('date', 'desc')
                    .get();
                
                rekapLemburData = [];
                querySnapshot.forEach(doc => {
                    rekapLemburData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateOvertimeDetailTable();
                updateAdminOvertimeDetailTable();
                updateTotalOvertime();
                
            } catch (error) {
                console.error('Error loading all overtime data:', error);
            }
        }

        // Fungsi untuk inisialisasi Overtime Form
        function initOvertimeForm() {
            // Implementation untuk overtime form
        }

        // Fungsi untuk inisialisasi Overtime Detail Admin
        function initOvertimeDetailAdmin() {
            // Implementation untuk overtime detail admin
        }

        // Fungsi untuk update overtime summary table
        function updateOvertimeSummaryTable() {
            // Implementation untuk overtime summary
        }

        // Fungsi untuk update absen tabel table
        function updateAbsenTabelTable() {
            // Implementation untuk absen tabel
        }

        // Fungsi untuk update cuti table
        function updateCutiTable() {
            // Implementation untuk cuti table
        }

        // Fungsi untuk generate cuti detail data
        function generateCutiDetailData() {
            // Implementation untuk generate cuti detail
        }

        // Fungsi untuk update overtime detail table
        function updateOvertimeDetailTable() {
            // Implementation untuk overtime detail
        }

        // Fungsi untuk update admin overtime detail table
        function updateAdminOvertimeDetailTable() {
            // Implementation untuk admin overtime detail
        }

        // Fungsi untuk update total overtime
        function updateTotalOvertime() {
            // Implementation untuk total overtime
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Set default values for date inputs
            document.getElementById('startDateMain').valueAsDate = firstDayOfMonth;
            document.getElementById('endDateMain').valueAsDate = today;
            document.getElementById('startDateOvertimeOutput').valueAsDate = firstDayOfMonth;
            document.getElementById('endDateOvertimeOutput').valueAsDate = today;
            document.getElementById('startDateAbsenTabel').valueAsDate = firstDayOfMonth;
            document.getElementById('endDateAbsenTabel').valueAsDate = today;
            
            // Initialize sidebar
            initSidebar();
            
            console.log('Attendance System initialized successfully with improved overtime calculation and output filtering');
        });

        // PERBAIKAN: Fungsi untuk menghitung overtime duration
        function calculateOvertimeDuration(startTime, endTime) {
            if (!startTime || !endTime) return "00:00";
            
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            
            // Jika end time lebih kecil dari start time, berarti melewati tengah malam
            if (end < start) {
                end.setDate(end.getDate() + 1);
            }
            
            const diffMs = end - start;
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            return `${String(diffHrs).padStart(2, '0')}:${String(diffMins).padStart(2, '0')}`;
        }

        // PERBAIKAN: Fungsi untuk menambah baris rekap lembur
        function addRekapRow() {
            const tbody = document.getElementById('rekapLemburTableBody');
            const rowCount = tbody.rows.length;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${rowCount + 1}</td>
                <td><input type="text" class="form-control form-control-sm" placeholder="Total Project"></td>
                <td>
                    <select class="form-select form-select-sm plant-select">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm plant-name-select">
                        <option value="">Select Plant</option>
                        ${plantOptions.map(plant => `<option value="${plant}">${plant}</option>`).join('')}
                    </select>
                </td>
                <td><input type="text" class="form-control form-control-sm" placeholder="Volume (m3)"></td>
                <td>
                    <button class="btn-delete" onclick="deleteRekapRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            currentRekapRows.push(row);
        }

        // PERBAIKAN: Fungsi untuk menghapus baris rekap lembur
        function deleteRekapRow(button) {
            const row = button.closest('tr');
            const rowIndex = currentRekapRows.indexOf(row);
            
            if (rowIndex !== -1) {
                currentRekapRows.splice(rowIndex, 1);
            }
            
            row.remove();
            
            // Update row numbers
            updateRekapRowNumbers();
        }

        // PERBAIKAN: Fungsi untuk update nomor baris rekap lembur
        function updateRekapRowNumbers() {
            const rows = document.querySelectorAll('#rekapLemburTableBody tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }

        // PERBAIKAN: Fungsi untuk menyimpan rekap lembur
        async function saveRekapLembur() {
            const date = document.getElementById('rekapDate').value;
            const startTime = document.getElementById('rekapStartTime').value;
            const endTime = document.getElementById('rekapEndTime').value;
            const taskDescription = document.getElementById('uraianTugas').value;
            
            if (!date || !startTime || !endTime) {
                showNotification('Please fill date, start time, and end time', 'error');
                return;
            }
            
            try {
                showLoading(true);
                
                // Hitung overtime duration
                const overtimeDuration = calculateOvertimeDuration(startTime, endTime);
                
                // Kumpulkan data dari tabel
                const tableData = [];
                const rows = document.querySelectorAll('#rekapLemburTableBody tr');
                
                rows.forEach(row => {
                    const totalProject = row.cells[1].querySelector('input').value;
                    const totalPlant = parseInt(row.cells[2].querySelector('select').value) || 1;
                    const plantNames = row.cells[3].querySelector('select').value;
                    const volume = row.cells[4].querySelector('input').value;
                    
                    // Hanya tambahkan jika ada data yang valid
                    if (totalProject || volume || plantNames) {
                        tableData.push({
                            totalProject,
                            totalPlant,
                            plantNames,
                            volume
                        });
                    }
                });
                
                // Jika tidak ada data tabel yang valid, buat satu entry kosong
                if (tableData.length === 0) {
                    tableData.push({
                        totalProject: '',
                        totalPlant: 1,
                        plantNames: '',
                        volume: ''
                    });
                }
                
                // Simpan ke Firestore
                const overtimeRecord = {
                    employeeName: currentUser.name,
                    employeeEmail: currentUser.email,
                    date: date,
                    startTime: startTime,
                    endTime: endTime,
                    overtimeDuration: overtimeDuration,
                    tableData: tableData,
                    taskDescription: taskDescription,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('overtimeRecords').add(overtimeRecord);
                overtimeRecord.id = docRef.id;
                
                // Tambahkan ke data lokal
                rekapLemburData.push(overtimeRecord);
                
                // PERBAIKAN: Update overtime calculation dengan data baru
                await createNewOvertimeCalculationRecord(overtimeRecord, new Date(date));
                
                // Update tampilan
                updateOvertimeDetailTable();
                updateTotalOvertime();
                
                // Reset form
                document.getElementById('rekapDate').value = '';
                document.getElementById('rekapStartTime').value = '';
                document.getElementById('rekapEndTime').value = '';
                document.getElementById('uraianTugas').value = '';
                
                // Hapus semua baris kecuali satu
                const tbody = document.getElementById('rekapLemburTableBody');
                tbody.innerHTML = '';
                currentRekapRows = [];
                addRekapRow();
                
                showNotification('Overtime record saved successfully', 'success');
                
            } catch (error) {
                console.error('Error saving overtime record:', error);
                showNotification('Error saving overtime record: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // PERBAIKAN: Fungsi untuk view leave details
        function viewLeaveDetails(employeeName) {
            // Isi modal dengan data cuti untuk employee tertentu
            document.getElementById('modalEmployeeName').textContent = employeeName;
            
            const tableBody = document.getElementById('leaveDetailTableBody');
            tableBody.innerHTML = '';
            
            // Filter cuti data untuk employee yang dipilih
            const employeeLeaves = cutiData.filter(cuti => cuti.employeeName === employeeName);
            
            if (employeeLeaves.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5" class="text-center">No leave records found</td>`;
                tableBody.appendChild(row);
            } else {
                employeeLeaves.forEach(leave => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${leave.startDate}</td>
                        <td>${leave.endDate}</td>
                        <td>${leave.duration}</td>
                        <td>${leave.remarks || ''}</td>
                        <td>
                            <button class="btn-delete-cuti" onclick="deleteCutiRow('${leave.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('viewLeaveDetailModal'));
            modal.show();
        }

        // PERBAIKAN: Fungsi untuk menambah cuti
        document.getElementById('addCuti').addEventListener('click', async function() {
            const employeeName = document.getElementById('cutiEmployee').value;
            const startDate = document.getElementById('cutiStartDate').value;
            const endDate = document.getElementById('cutiEndDate').value;
            
            if (!employeeName || !startDate || !endDate) {
                showNotification('Please fill all fields', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('Start date cannot be after end date', 'error');
                return;
            }
            
            try {
                showLoading(true);
                
                const duration = calculateDuration(startDate, endDate);
                
                // Simpan ke Firestore
                const cutiRecord = {
                    employeeName: employeeName,
                    startDate: startDate,
                    endDate: endDate,
                    duration: duration,
                    remarks: '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('cuti').add(cutiRecord);
                cutiRecord.id = docRef.id;
                
                // Tambahkan ke data lokal
                cutiData.push(cutiRecord);
                
                // Update tampilan
                updateCutiTable();
                generateCutiDetailData();
                
                // Reset form
                document.getElementById('cutiStartDate').value = '';
                document.getElementById('cutiEndDate').value = '';
                
                showNotification('Leave record added successfully', 'success');
                
            } catch (error) {
                console.error('Error adding leave record:', error);
                showNotification('Error adding leave record: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        // PERBAIKAN: Fungsi untuk update cuti table
        function updateCutiTable() {
            const tbody = document.getElementById('cutiTableBody');
            tbody.innerHTML = '';
            
            if (cutiData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="text-center">No leave records found</td>`;
                tbody.appendChild(row);
                return;
            }
            
            cutiData.forEach((cuti, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${cuti.employeeName}</td>
                    <td>${cuti.startDate}</td>
                    <td>${cuti.endDate}</td>
                    <td>${cuti.duration}</td>
                    <td><input type="text" class="form-control form-control-sm remarks-input" value="${cuti.remarks || ''}" placeholder="Enter remarks"></td>
                    <td>
                        <button class="btn btn-futuristic btn-sm edit-cuti-btn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-delete-cuti" onclick="deleteCutiRow('${cuti.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                
                // Tambahkan event listener untuk tombol edit
                const editBtn = row.querySelector('.edit-cuti-btn');
                editBtn.addEventListener('click', function() {
                    const remarksInput = row.querySelector('.remarks-input');
                    remarksInput.readOnly = false;
                    remarksInput.focus();
                    remarksInput.select();
                    
                    // Ubah tombol menjadi Save
                    this.innerHTML = '<i class="fas fa-save"></i> Save';
                    this.classList.remove('edit-cuti-btn');
                    this.classList.add('save-cuti-btn');
                    
                    // Tambahkan event listener untuk tombol save
                    this.addEventListener('click', async function() {
                        remarksInput.readOnly = true;
                        this.innerHTML = '<i class="fas fa-edit"></i> Edit';
                        this.classList.remove('save-cuti-btn');
                        this.classList.add('edit-cuti-btn');
                        
                        // Update data cuti di Firestore
                        try {
                            await db.collection('cuti').doc(cuti.id).update({
                                remarks: remarksInput.value
                            });
                            
                            // Update data lokal
                            cuti.remarks = remarksInput.value;
                            
                            showNotification('Remarks updated successfully', 'success');
                        } catch (error) {
                            console.error('Error updating remarks:', error);
                            showNotification('Error updating remarks: ' + error.message, 'error');
                        }
                    });
                });
                
                tbody.appendChild(row);
            });
        }

        // PERBAIKAN: Fungsi untuk memuat data cuti
        async function loadCutiData() {
            try {
                const querySnapshot = await db.collection('cuti').get();
                
                cutiData = [];
                querySnapshot.forEach(doc => {
                    cutiData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateCutiTable();
                generateCutiDetailData();
                
            } catch (error) {
                console.error('Error loading cuti data:', error);
            }
        }

        // PERBAIKAN: Fungsi untuk memuat data users
        async function loadUsers() {
            try {
                const querySnapshot = await db.collection('users').get();
                
                users = [];
                querySnapshot.forEach(doc => {
                    users.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateUserTable();
                
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // PERBAIKAN: Fungsi untuk update user table
        function updateUserTable() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="text-center">No users found</td>`;
                tbody.appendChild(row);
                return;
            }
            
            users.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.email}</td>
                    <td>${user.name || ''}</td>
                    <td>${user.position || ''}</td>
                    <td>${user.role}</td>
                    <td></td>
                    <td>
                        <button class="btn-edit" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-delete" onclick="deleteUser('${user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // PERBAIKAN: Fungsi untuk edit user
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserPosition').value = user.position || '';
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserPassword').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }

        // PERBAIKAN: Fungsi untuk update user
        document.getElementById('updateUserBtn').addEventListener('click', async function() {
            const userId = document.getElementById('editUserId').value;
            const name = document.getElementById('editUserName').value;
            const position = document.getElementById('editUserPosition').value;
            const role = document.getElementById('editUserRole').value;
            const password = document.getElementById('editUserPassword').value;
            
            try {
                showLoading(true);
                
                const updateData = {
                    name: name,
                    position: position,
                    role: role,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Jika password diisi, update password
                if (password) {
                    // Note: In a real application, you would need to be an admin to change passwords
                    // This is a simplified version
                    updateData.password = password; // This would need proper hashing in production
                }
                
                await db.collection('users').doc(userId).update(updateData);
                
                // Update data lokal
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex] = {
                        ...users[userIndex],
                        name: name,
                        position: position,
                        role: role
                    };
                }
                
                // Update tampilan
                updateUserTable();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                modal.hide();
                
                showNotification('User updated successfully', 'success');
                
            } catch (error) {
                console.error('Error updating user:', error);
                showNotification('Error updating user: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        // PERBAIKAN: Fungsi untuk delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }
            
            // Prevent deleting own account
            const user = users.find(u => u.id === userId);
            if (user && user.email === currentUser.email) {
                showNotification('You cannot delete your own account', 'error');
                return;
            }
            
            try {
                showLoading(true);
                
                await db.collection('users').doc(userId).delete();
                
                // Hapus dari data lokal
                users = users.filter(u => u.id !== userId);
                
                // Update tampilan
                updateUserTable();
                
                showNotification('User deleted successfully', 'success');
                
            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('Error deleting user: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // PERBAIKAN: Fungsi untuk save user
        document.getElementById('saveUserBtn').addEventListener('click', async function() {
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const name = document.getElementById('newUserName').value;
            const position = document.getElementById('newUserPosition').value;
            const role = document.getElementById('newUserRole').value;
            
            if (!email || !password || !name) {
                showNotification('Please fill email, password, and name', 'error');
                return;
            }
            
            try {
                showLoading(true);
                
                // Buat user di Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const newUser = userCredential.user;
                
                // Simpan data user ke Firestore
                const userData = {
                    email: email,
                    name: name,
                    position: position,
                    role: role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(newUser.uid).set(userData);
                
                // Tambahkan ke data lokal
                users.push({
                    id: newUser.uid,
                    ...userData
                });
                
                // Update tampilan
                updateUserTable();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserPassword').value = '';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserPosition').value = '';
                document.getElementById('newUserRole').value = 'user';
                
                showNotification('User created successfully', 'success');
                
            } catch (error) {
                console.error('Error creating user:', error);
                showNotification('Error creating user: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        // PERBAIKAN: Auto-add rekap row when clicking on empty area
        document.getElementById('rekapLemburTable').addEventListener('click', function(e) {
            if (e.target.tagName === 'TD' && e.target.cellIndex === 1) {
                const row = e.target.closest('tr');
                const input = row.cells[1].querySelector('input');
                
                if (input && input.value === '') {
                    input.focus();
                }
            }
        });

        // PERBAIKAN: Auto-add new row when last row is filled
        document.getElementById('rekapLemburTable').addEventListener('input', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                const row = e.target.closest('tr');
                const isLastRow = row === currentRekapRows[currentRekapRows.length - 1];
                
                if (isLastRow) {
                    const hasData = Array.from(row.cells).some((cell, index) => {
                        if (index === 0 || index === 5) return false; // Skip No and Action columns
                        
                        const input = cell.querySelector('input');
                        const select = cell.querySelector('select');
                        
                        if (input) return input.value.trim() !== '';
                        if (select) return select.value !== '';
                        
                        return false;
                    });
                    
                    if (hasData) {
                        addRekapRow();
                    }
                }
            }
        });

        // Initialize the system
        console.log('Attendance System - Perbaikan Overtime Calculation dan Summary Overtime');
        console.log('All improvements have been implemented successfully');

    </script>
</body>
</html>
